# ë‚´ì¼ë°°ì›€ìº í”„ 240526 TIL
Java 29ì¼ì°¨
ì¸ì¦ê³¼ ì¸ê°€
-------------------------------------------------------------------------------

## 05. JWTë€ ë¬´ì—‡ì¼ê¹Œ?

- JWT ë€?
    ğŸª JWT(Json Web Token)ë€ JSON í¬ë§·ì„ ì´ìš©í•˜ì—¬ ì‚¬ìš©ìì— ëŒ€í•œ ì†ì„±ì„ ì €ì¥í•˜ëŠ” Claim ê¸°ë°˜ì˜ Web Token ì…ë‹ˆë‹¤. ì¦‰, í† í°ì˜ í•œ ì¢…ë¥˜ë¼ê³  ìƒê°í•˜ì‹œë©´ ë©ë‹ˆë‹¤.
    ì¼ë°˜ì ìœ¼ë¡œ ì¿ í‚¤ ì €ì¥ì†Œë¥¼ ì‚¬ìš©í•˜ì—¬ JWTë¥¼ ì €ì¥í•©ë‹ˆë‹¤.

- JWT ì‚¬ìš© ì´ìœ 
    1. ì„œë²„ê°€ 1ëŒ€ì¸ ê²½ìš°
        - Session1 ì´ ëª¨ë“  Clientì˜ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì†Œìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤.

    2. ì„œë²„ê°€ 2ëŒ€ ì´ìƒì¸ ê²½ìš°
        - ì„œë²„ì˜ ëŒ€ìš©ëŸ‰ íŠ¸ë˜í”½ ì²˜ë¦¬ë¥¼ ìœ„í•´ ì„œë²„ 2ëŒ€ ì´ìƒ ìš´ì˜ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - Session ë§ˆë‹¤ ë‹¤ë¥¸ Client ë¡œê·¸ì¸ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            - Session1: Client1, Client2, Client3
            - Session2: Client4
            - Session3: Client5, Client6
        - ë§Œì•½ Client 1ì˜ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆì§€ ì•Šì€ Sever2 ë‚˜ Server3 ì— API ìš”ì²­ì„ í•˜ê²Œë˜ë©´ ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•Šì„ê¹Œ?
            - í•´ê²°ë°©ë²•
                1) Sticky Session: Client ë§ˆë‹¤ ìš”ì²­ Server ê³ ì •í•©ë‹ˆë‹¤.
                2) ì„¸ì…˜ ì €ì¥ì†Œ ìƒì„±í•˜ì—¬ ëª¨ë“  ì„¸ì…˜ì„ ì €ì¥í•©ë‹ˆë‹¤.

    3. ì„¸ì…˜ ì €ì¥ì†Œ ìƒì„±
        - Session storage ê°€ ëª¨ë“  Client ì˜ ë¡œê·¸ì¸ ì •ë³´ ì†Œìœ í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ëª¨ë“  ì„œë²„ì—ì„œ ëª¨ë“  Clientì˜ API ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    1. JWT ì‚¬ìš©
        - ë¡œê·¸ì¸ ì •ë³´ë¥¼ **Server** ì— ì €ì¥í•˜ì§€ ì•Šê³ , **Client** ì— ë¡œê·¸ì¸ ì •ë³´ë¥¼ JWT ë¡œ ì•”í˜¸í™”í•˜ì—¬ ì €ì¥ â†’ JWT í†µí•´ ì¸ì¦/ì¸ê°€
        - ëª¨ë“  ì„œë²„ì—ì„œ **ë™ì¼í•œ Secret Key** ì†Œìœ í•©ë‹ˆë‹¤.
        - Secret Key í†µí•œ ì•”í˜¸í™” / ìœ„ì¡° ê²€ì¦ (ë³µí˜¸í™” ì‹œ)
        - JWT ì¥/ë‹¨ì 
            1. ì¥ì 
                - ë™ì‹œ ì ‘ì†ìê°€ ë§ì„ ë•Œ ì„œë²„ ì¸¡ ë¶€í•˜ ë‚®ì¶¤
                - Client, Sever ê°€ ë‹¤ë¥¸ ë„ë©”ì¸ì„ ì‚¬ìš©í•  ë•Œ
                    - ì˜ˆ) ì¹´ì¹´ì˜¤ OAuth2 ë¡œê·¸ì¸ ì‹œ JWT Token ì‚¬ìš©
            2. ë‹¨ì 
                - êµ¬í˜„ì˜ ë³µì¡ë„ ì¦ê°€
                - JWT ì— ë‹´ëŠ” ë‚´ìš©ì´ ì»¤ì§ˆ ìˆ˜ë¡ ë„¤íŠ¸ì›Œí¬ ë¹„ìš© ì¦ê°€ (í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„)
                - ê¸° ìƒì„±ëœ JWT ë¥¼ ì¼ë¶€ë§Œ ë§Œë£Œì‹œí‚¬ ë°©ë²•ì´ ì—†ìŒ
                - Secret key ìœ ì¶œ ì‹œ JWT ì¡°ì‘ ê°€ëŠ¥

- JWT ì‚¬ìš© íë¦„
    1. Client ê°€ username, password ë¡œ ë¡œê·¸ì¸ ì„±ê³µ ì‹œ
        1. ì„œë²„ì—ì„œ "ë¡œê·¸ì¸ ì •ë³´" â†’ JWT ë¡œ **ì•”í˜¸í™”** (Secret Key ì‚¬ìš©)
        2. ì„œë²„ì—ì„œ ì§ì ‘ ì¿ í‚¤ë¥¼ ìƒì„±í•´ **JWT**ë¥¼ ë‹´ì•„ Client ì‘ë‹µì— ì „ë‹¬
            1. JWT ì „ë‹¬ë°©ë²•ì€ ê°œë°œìê°€ ì •í•¨
                - ì‘ë‹µ **Header**ì— ì•„ë˜ **í˜•íƒœ**ë¡œ JWT ì „ë‹¬

                    ```java
                    Cookie cookie = new Cookie(AUTHORIZATION_HEADER, token); // Name-Value
                    cookie.setPath("/");

                    // Response ê°ì²´ì— Cookie ì¶”ê°€
                    res.addCookie(cookie);
                    ```

        3. ë¸Œë¼ìš°ì € ì¿ í‚¤ ì €ì¥ì†Œì— ìë™ìœ¼ë¡œ JWT ì €ì¥ë¨

    2. Client ì—ì„œ JWT í†µí•´ ì¸ì¦ë°©ë²•
        1. ì„œë²„ì—ì„œ API ìš”ì²­ ì‹œë§ˆë‹¤ ì¿ í‚¤ì— í¬í•¨ëœ JWTë¥¼ ì°¾ì•„ì„œ ì‚¬ìš©
            - ì¿ í‚¤ë¥¼ ì°¾ëŠ” ì½”ë“œ

            ```java
            // HttpServletRequest ì—ì„œ Cookie Value : JWT ê°€ì ¸ì˜¤ê¸°
            public String getTokenFromRequest(HttpServletRequest req) {
                Cookie[] cookies = req.getCookies();
                if(cookies != null) {
                    for (Cookie cookie : cookies) {
                        if (cookie.getName().equals(AUTHORIZATION_HEADER)) {
                            try {
                                return URLDecoder.decode(cookie.getValue(), "UTF-8"); // Encode ë˜ì–´ ë„˜ì–´ê°„ Value ë‹¤ì‹œ Decode
                            } catch (UnsupportedEncodingException e) {
                                return null;
                            }
                        }
                    }
                }
                return null;
            }
            ```

            - ì¿ í‚¤ì— ë‹´ê¸´ ì •ë³´ê°€ ì—¬ëŸ¬ ê°œì¼ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ê·¸ ì¤‘ ì´ë¦„ì´ JWTê°€ ë‹´ê¸´ ì¿ í‚¤ì˜ ì´ë¦„ê³¼ ë™ì¼í•œì§€ í™•ì¸í•˜ì—¬ JWTë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

        2. Server
            1. Client ê°€ ì „ë‹¬í•œ **JWT ìœ„ì¡° ì—¬ë¶€ ê²€ì¦** (Secret Key ì‚¬ìš©)
            2. JWT ìœ íš¨ê¸°ê°„ì´ ì§€ë‚˜ì§€ ì•Šì•˜ëŠ”ì§€ ê²€ì¦
            3. ê²€ì¦ ì„±ê³µì‹œ,
                1. JWT â†’ ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì™€ í™•ì¸

                    ex) **GET /api/products** : JWT ë³´ë‚¸ ì‚¬ìš©ìì˜ ê´€ì‹¬ìƒí’ˆ ëª©ë¡ ì¡°íšŒ

- JWT êµ¬ì¡°
    - JWT ëŠ” ëˆ„êµ¬ë‚˜ í‰ë¬¸ìœ¼ë¡œ ë³µí˜¸í™” ê°€ëŠ¥í•©ë‹ˆë‹¤.
    - í•˜ì§€ë§Œ Secret Key ê°€ ì—†ìœ¼ë©´ JWT ìˆ˜ì • ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.
        â†’ ê²°êµ­ JWT ëŠ” **Read only ë°ì´í„°ì…ë‹ˆë‹¤.**
        - **[ì½”ë“œìŠ¤ë‹ˆí«] [jwt.io](https://jwt.io/)**

            ```
            https://jwt.io/
            ```

    1. Header

        ```json
        {
          "alg": "HS256",
          "typ": "JWT"
        }
        ```

    2. Payload

        ```json
        {
          "sub": "1234567890",
          "username": "ì¹´ì¦ˆí•˜",
          "admin": true
        }
        ```

    3. Signature

        ```json
        HMACSHA256(
          base64UrlEncode(header) + "." +
          base64UrlEncode(payload),
          secret)
        ```

    - Payloadì— ì‹¤ì œ ìœ ì €ì˜ ì •ë³´ê°€ ë“¤ì–´ìˆê³ , HEADERì™€ VERIFY SIGNATUREë¶€ë¶„ì€ ì•”í˜¸í™” ê´€ë ¨ëœ ì •ë³´ ì–‘ì‹ì´ë¼ê³  ìƒê°í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

## 06. JWT ë‹¤ë£¨ê¸°

- í”„ë¡œì íŠ¸ ì„¤ì •
    - **[ì½”ë“œìŠ¤ë‹ˆí«] JWT dependency ì¶”ê°€í•˜ê¸°**

        ```groovy
        // JWT
        compileOnly group: 'io.jsonwebtoken', name: 'jjwt-api', version: '0.11.5'
        runtimeOnly group: 'io.jsonwebtoken', name: 'jjwt-impl', version: '0.11.5'
        runtimeOnly group: 'io.jsonwebtoken', name: 'jjwt-jackson', version: '0.11.5'
        ```

    - **[ì½”ë“œìŠ¤ë‹ˆí«] application.properties**

        ```groovy
        jwt.secret.key=7Iqk7YyM66W07YOA7L2U65Sp7YG065+9U3ByaW5n6rCV7J2Y7Yqc7YSw7LWc7JuQ67mI7J6F64uI64ukLg==
        ```

- JwtUtil ë§Œë“¤ê¸°
    ğŸ“Œ Util í´ë˜ìŠ¤ë€ íŠ¹ì • ë§¤ê°œ ë³€ìˆ˜(íŒŒë¼ë¯¸í„°)ì— ëŒ€í•œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë©”ì„œë“œë“¤ì´ ì¡´ì¬í•˜ëŠ” í´ë˜ìŠ¤ë¥¼ ëœ»í•©ë‹ˆë‹¤.
    ì‰½ê²Œ ì„¤ëª…í•˜ìë©´ ë‹¤ë¥¸ ê°ì²´ì— ì˜ì¡´í•˜ì§€ ì•Šê³  í•˜ë‚˜ì˜ ëª¨ë“ˆë¡œì„œ ë™ì‘í•˜ëŠ” í´ë˜ìŠ¤ë¼ê³  ìƒê°í•˜ì‹œë©´ ì¢‹ìŠµë‹ˆë‹¤.
    ìš°ë¦¬ëŠ” JWT ê´€ë ¨ ê¸°ëŠ¥ë“¤ì„ ê°€ì§„ JwtUtilì´ë¼ëŠ” í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ JWT ê´€ë ¨ ê¸°ëŠ¥ì„ ìˆ˜í–‰ì‹œí‚¬ ì˜ˆì •ì…ë‹ˆë‹¤.
    <JWT ê´€ë ¨ ê¸°ëŠ¥>
    1. JWT ìƒì„±
    2. ìƒì„±ëœ JWTë¥¼ Cookieì— ì €ì¥
    3. Cookieì— ë“¤ì–´ìˆë˜ JWT í† í°ì„ Substring
    4. JWT ê²€ì¦
    5. JWTì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°

    - í† í° ìƒì„±ì— í•„ìš”í•œ ë°ì´í„°

        ```java
        // Header KEY ê°’
        public static final String AUTHORIZATION_HEADER = "Authorization";
        // ì‚¬ìš©ì ê¶Œí•œ ê°’ì˜ KEY
        public static final String AUTHORIZATION_KEY = "auth";
        // Token ì‹ë³„ì
        public static final String BEARER_PREFIX = "Bearer ";
        // í† í° ë§Œë£Œì‹œê°„
        private final long TOKEN_TIME = 60 * 60 * 1000L; // 60ë¶„

        @Value("${jwt.secret.key}") // Base64 Encode í•œ SecretKey
        private String secretKey;
        private Key key;
        private final SignatureAlgorithm signatureAlgorithm = SignatureAlgorithm.HS256;

        // ë¡œê·¸ ì„¤ì •
        public static final Logger logger = LoggerFactory.getLogger("JWT ê´€ë ¨ ë¡œê·¸");

        @PostConstruct
        public void init() {
            byte[] bytes = Base64.getDecoder().decode(secretKey);
            key = Keys.hmacShaKeyFor(bytes);
        }
        ```

        - [ì½”ë“œ ìŠ¤ë‹ˆí«] JWT ë°ì´í„°

            ```java
            package com.sparta.springauth.jwt;

            import io.jsonwebtoken.SignatureAlgorithm;
            import io.jsonwebtoken.security.Keys;
            import jakarta.annotation.PostConstruct;
            import org.slf4j.Logger;
            import org.slf4j.LoggerFactory;
            import org.springframework.beans.factory.annotation.Value;
            import org.springframework.stereotype.Component;

            import java.security.Key;
            import java.util.Base64;

            @Component
            public class JwtUtil {
                // Header KEY ê°’
                public static final String AUTHORIZATION_HEADER = "Authorization";
                // ì‚¬ìš©ì ê¶Œí•œ ê°’ì˜ KEY
                public static final String AUTHORIZATION_KEY = "auth";
                // Token ì‹ë³„ì
                public static final String BEARER_PREFIX = "Bearer ";
                // í† í° ë§Œë£Œì‹œê°„
                private final long TOKEN_TIME = 60 * 60 * 1000L; // 60ë¶„

                @Value("${jwt.secret.key}") // Base64 Encode í•œ SecretKey
                private String secretKey;
                private Key key;
                private final SignatureAlgorithm signatureAlgorithm = SignatureAlgorithm.HS256;

                // ë¡œê·¸ ì„¤ì •
                public static final Logger logger = LoggerFactory.getLogger("JWT ê´€ë ¨ ë¡œê·¸");

                @PostConstruct
                public void init() {
                    byte[] bytes = Base64.getDecoder().decode(secretKey);
                    key = Keys.hmacShaKeyFor(bytes);
                }

            }
            ```

        - Base64ë¡œ Encodeëœ Secret Keyë¥¼ propertiesì— ì‘ì„±í•´ë‘ê³  @Valueë¥¼ í†µí•´ ê°€ì ¸ì˜µë‹ˆë‹¤.
        - JWTë¥¼ ìƒì„±í•  ë•Œ ê°€ì ¸ì˜¨ Secret Keyë¡œ ì•”í˜¸í™”í•©ë‹ˆë‹¤.
            - ì´ë•Œ Encodeëœ Secret Keyë¥¼ Decode í•´ì„œ ì‚¬ìš©í•©ë‹ˆë‹¤.
            - KeyëŠ” Decodeëœ Secret Keyë¥¼ ë‹´ëŠ” ê°ì²´ì…ë‹ˆë‹¤.
            - @PostConstructëŠ” ë”± í•œ ë²ˆë§Œ ë°›ì•„ì˜¤ë©´ ë˜ëŠ” ê°’ì„ ì‚¬ìš© í•  ë•Œë§ˆë‹¤ ìš”ì²­ì„ ìƒˆë¡œ í˜¸ì¶œí•˜ëŠ” ì‹¤ìˆ˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤.
                - JwtUtil í´ë˜ìŠ¤ì˜ ìƒì„±ì í˜¸ì¶œ ì´í›„ì— ì‹¤í–‰ë˜ì–´ Key í•„ë“œì— ê°’ì„ ì£¼ì… í•´ì¤ë‹ˆë‹¤.
        - ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜ì€ HS256 ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        - Bearer ë€ JWT í˜¹ì€ OAuthì— ëŒ€í•œ í† í°ì„ ì‚¬ìš©í•œë‹¤ëŠ” í‘œì‹œì…ë‹ˆë‹¤.
        - ë¡œê¹…ì´ë€ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë™ì‘í•˜ëŠ” ë™ì•ˆ í”„ë¡œì íŠ¸ì˜ ìƒíƒœë‚˜ ë™ì‘ ì •ë³´ë¥¼ ì‹œê°„ìˆœìœ¼ë¡œ ê¸°ë¡í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
            - ìš°ë¦¬ëŠ” Logback ë¡œê¹… í”„ë ˆì„ì›Œí¬ë¥¼ ì‚¬ìš©í•´ì„œ ë¡œê¹…ì„ ì§„í–‰í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.
        ğŸ“Œ ì‚¬ìš©ìì˜ ê¶Œí•œì˜ ì¢…ë¥˜ë¥¼ Enumì„ ì‚¬ìš©í•´ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.
        - JWTë¥¼ ìƒì„±í•  ë•Œ ì‚¬ìš©ìì˜ ì •ë³´ë¡œ í•´ë‹¹ ì‚¬ìš©ìì˜ ê¶Œí•œì„ ë„£ì–´ì¤„ ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

        ```java
        public enum UserRoleEnum {
            USER(Authority.USER),  // ì‚¬ìš©ì ê¶Œí•œ
            ADMIN(Authority.ADMIN);  // ê´€ë¦¬ì ê¶Œí•œ

            private final String authority;

            UserRoleEnum(String authority) {
                this.authority = authority;
            }

            public String getAuthority() {
                return this.authority;
            }

            public static class Authority {
                public static final String USER = "ROLE_USER";
                public static final String ADMIN = "ROLE_ADMIN";
            }
        }
        ```

        - [ì½”ë“œ ìŠ¤ë‹ˆí«] entity > UserRoleEnum

            ```java
            package com.sparta.springauth.entity;

            public enum UserRoleEnum {
                USER(Authority.USER),  // ì‚¬ìš©ì ê¶Œí•œ
                ADMIN(Authority.ADMIN);  // ê´€ë¦¬ì ê¶Œí•œ

                private final String authority;

                UserRoleEnum(String authority) {
                    this.authority = authority;
                }

                public String getAuthority() {
                    return this.authority;
                }

                public static class Authority {
                    public static final String USER = "ROLE_USER";
                    public static final String ADMIN = "ROLE_ADMIN";
                }
            }
            ```

    - 1.JWT ìƒì„±

        ```java
        // í† í° ìƒì„±
        public String createToken(String username, UserRoleEnum role) {
            Date date = new Date();

            return BEARER_PREFIX +
                    Jwts.builder()
                            .setSubject(username) // ì‚¬ìš©ì ì‹ë³„ìê°’(ID)
                            .claim(AUTHORIZATION_KEY, role) // ì‚¬ìš©ì ê¶Œí•œ
                            .setExpiration(new Date(date.getTime() + TOKEN_TIME)) // ë§Œë£Œ ì‹œê°„
                            .setIssuedAt(date) // ë°œê¸‰ì¼
                            .signWith(key, signatureAlgorithm) // ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜
                            .compact();
        }
        ```

        - [ì½”ë“œ ìŠ¤ë‹ˆí«] JWT ìƒì„±

            ```java
            // í† í° ìƒì„±
            public String createToken(String username, UserRoleEnum role) {
                Date date = new Date();

                return BEARER_PREFIX +
                        Jwts.builder()
                                .setSubject(username) // ì‚¬ìš©ì ì‹ë³„ìê°’(ID)
                                .claim(AUTHORIZATION_KEY, role) // ì‚¬ìš©ì ê¶Œí•œ
                                .setExpiration(new Date(date.getTime() + TOKEN_TIME)) // ë§Œë£Œ ì‹œê°„
                                .setIssuedAt(date) // ë°œê¸‰ì¼
                                .signWith(key, signatureAlgorithm) // ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜
                                .compact();
            }
            ```

        - JWTì˜ subjectì— ì‚¬ìš©ìì˜ ì‹ë³„ê°’ ì¦‰, IDë¥¼ ë„£ìŠµë‹ˆë‹¤.
        - JWTì— ì‚¬ìš©ìì˜ ê¶Œí•œ ì •ë³´ë¥¼ ë„£ìŠµë‹ˆë‹¤. key-value í˜•ì‹ìœ¼ë¡œ key ê°’ì„ í†µí•´ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - í† í° ë§Œë£Œì‹œê°„ì„ ë„£ìŠµë‹ˆë‹¤. ms ê¸°ì¤€ì…ë‹ˆë‹¤.
        - issuedAtì— ë°œê¸‰ì¼ì„ ë„£ìŠµë‹ˆë‹¤.
        - signWithì— secretKey ê°’ì„ ë‹´ê³ ìˆëŠ” keyì™€ ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜ì„ ê°’ì„ ë„£ì–´ì¤ë‹ˆë‹¤.
            - ketì™€ ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ì—¬ JWTë¥¼ ì•”í˜¸í™”í•©ë‹ˆë‹¤.

    - 2.JWT Cookieì— ì €ì¥

        ```java
        // JWT Cookie ì— ì €ì¥
        public void addJwtToCookie(String token, HttpServletResponse res) {
            try {
                token = URLEncoder.encode(token, "utf-8").replaceAll("\\+", "%20"); // Cookie Value ì—ëŠ” ê³µë°±ì´ ë¶ˆê°€ëŠ¥í•´ì„œ encoding ì§„í–‰

                Cookie cookie = new Cookie(AUTHORIZATION_HEADER, token); // Name-Value
                cookie.setPath("/");

                // Response ê°ì²´ì— Cookie ì¶”ê°€
                res.addCookie(cookie);
            } catch (UnsupportedEncodingException e) {
                logger.error(e.getMessage());
            }
        }
        ```

        - [ì½”ë“œ ìŠ¤ë‹ˆí«] JWT Cookieì— ì €ì¥

            ```java
            // JWT Cookie ì— ì €ì¥
            public void addJwtToCookie(String token, HttpServletResponse res) {
                try {
                    token = URLEncoder.encode(token, "utf-8").replaceAll("\\+", "%20"); // Cookie Value ì—ëŠ” ê³µë°±ì´ ë¶ˆê°€ëŠ¥í•´ì„œ encoding ì§„í–‰

                    Cookie cookie = new Cookie(AUTHORIZATION_HEADER, token); // Name-Value
                    cookie.setPath("/");

                    // Response ê°ì²´ì— Cookie ì¶”ê°€
                    res.addCookie(cookie);
                } catch (UnsupportedEncodingException e) {
                    logger.error(e.getMessage());
                }
            }
            ```

    - 3.ë°›ì•„ì˜¨ Cookieì˜ Valueì¸ JWT í† í° substring

        ```java
        // JWT í† í° substring
        public String substringToken(String tokenValue) {
            if (StringUtils.hasText(tokenValue) && tokenValue.startsWith(BEARER_PREFIX)) {
                return tokenValue.substring(7);
            }
            logger.error("Not Found Token");
            throw new NullPointerException("Not Found Token");
        }
        ```

        - [ì½”ë“œ ìŠ¤ë‹ˆí«] JWT í† í° substring

            ```java
            // JWT í† í° substring
            public String substringToken(String tokenValue) {
                if (StringUtils.hasText(tokenValue) && tokenValue.startsWith(BEARER_PREFIX)) {
                    return tokenValue.substring(7);
                }
                logger.error("Not Found Token");
                throw new NullPointerException("Not Found Token");
            }
            ```

        - StringUtils.hasTextë¥¼ ì‚¬ìš©í•˜ì—¬ ê³µë°±, nullì„ í™•ì¸í•˜ê³  startsWithì„ ì‚¬ìš©í•˜ì—¬ í† í°ì˜ ì‹œì‘ê°’ì´ Bearerì´ ë§ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
        - ë§ë‹¤ë©´ ìˆœìˆ˜ JWTë¥¼ ë°˜í™˜í•˜ê¸° ìœ„í•´ substringì„ ì‚¬ìš©í•˜ì—¬ Bearerì„ ì˜ë¼ëƒ…ë‹ˆë‹¤.

    - 4.JWT ê²€ì¦

        ```java
        // í† í° ê²€ì¦
        public boolean validateToken(String token) {
            try {
                Jwts.parserBuilder().setSigningKey(key).build().parseClaimsJws(token);
                return true;
            } catch (SecurityException | MalformedJwtException | SignatureException e) {
                logger.error("Invalid JWT signature, ìœ íš¨í•˜ì§€ ì•ŠëŠ” JWT ì„œëª… ì…ë‹ˆë‹¤.");
            } catch (ExpiredJwtException e) {
                logger.error("Expired JWT token, ë§Œë£Œëœ JWT token ì…ë‹ˆë‹¤.");
            } catch (UnsupportedJwtException e) {
                logger.error("Unsupported JWT token, ì§€ì›ë˜ì§€ ì•ŠëŠ” JWT í† í° ì…ë‹ˆë‹¤.");
            } catch (IllegalArgumentException e) {
                logger.error("JWT claims is empty, ì˜ëª»ëœ JWT í† í° ì…ë‹ˆë‹¤.");
            }
            return false;
        }
        ```

        - [ì½”ë“œ ìŠ¤ë‹ˆí«] JWT ê²€ì¦

            ```java
            // í† í° ê²€ì¦
            public boolean validateToken(String token) {
                try {
                    Jwts.parserBuilder().setSigningKey(key).build().parseClaimsJws(token);
                    return true;
                } catch (SecurityException | MalformedJwtException | SignatureException e) {
                    logger.error("Invalid JWT signature, ìœ íš¨í•˜ì§€ ì•ŠëŠ” JWT ì„œëª… ì…ë‹ˆë‹¤.");
                } catch (ExpiredJwtException e) {
                    logger.error("Expired JWT token, ë§Œë£Œëœ JWT token ì…ë‹ˆë‹¤.");
                } catch (UnsupportedJwtException e) {
                    logger.error("Unsupported JWT token, ì§€ì›ë˜ì§€ ì•ŠëŠ” JWT í† í° ì…ë‹ˆë‹¤.");
                } catch (IllegalArgumentException e) {
                    logger.error("JWT claims is empty, ì˜ëª»ëœ JWT í† í° ì…ë‹ˆë‹¤.");
                }
                return false;
            }
            ```

        - `Jwts.parserBuilder()` ë¥¼ ì‚¬ìš©í•˜ì—¬ JWTë¥¼ íŒŒì‹±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - JWTê°€ ìœ„ë³€ì¡°ë˜ì§€ ì•Šì•˜ëŠ”ì§€ secretKey(key)ê°’ì„ ë„£ì–´ í™•ì¸í•©ë‹ˆë‹¤.

    - 5.JWTì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°

        ```java
        // í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        public Claims getUserInfoFromToken(String token) {
            return Jwts.parserBuilder().setSigningKey(key).build().parseClaimsJws(token).getBody();
        }
        ```

        - [ì½”ë“œ ìŠ¤ë‹ˆí«] JWTì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°

            ```java
            // í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            public Claims getUserInfoFromToken(String token) {
                return Jwts.parserBuilder().setSigningKey(key).build().parseClaimsJws(token).getBody();
            }
            ```

        - JWTì˜ êµ¬ì¡° ì¤‘ **Payload**Â ë¶€ë¶„ì—ëŠ” í† í°ì— ë‹´ê¸´ ì •ë³´ê°€ ë“¤ì–´ìˆìŠµë‹ˆë‹¤.
        - ì—¬ê¸°ì— ë‹´ê¸´ ì •ë³´ì˜ í•œ â€˜ì¡°ê°â€™ ì„ í´ë ˆì„(**claim**) ì´ë¼ê³  ë¶€ë¥´ê³ , ì´ëŠ” key-value ì˜ í•œ ìŒìœ¼ë¡œ ì´ë¤„ì ¸ìˆìŠµë‹ˆë‹¤. í† í°ì—ëŠ” ì—¬ëŸ¬ê°œì˜ í´ë ˆì„ ë“¤ì„ ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - `Jwts.parserBuilder()` ì™€ secretKeyë¥¼ ì‚¬ìš©í•˜ì—¬ JWTì˜ Claimsë¥¼ ê°€ì ¸ì™€ ë‹´ê²¨ ìˆëŠ” ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

    - JwtUtil ì™„ì„±
        - **[ì½”ë“œ ìŠ¤ë‹ˆí«] JwtUtil**

            ```java
            package com.sparta.springauth.jwt;

            import com.sparta.springauth.entity.UserRoleEnum;
            import io.jsonwebtoken.*;
            import io.jsonwebtoken.security.Keys;
            import jakarta.annotation.PostConstruct;
            import jakarta.servlet.http.Cookie;
            import jakarta.servlet.http.HttpServletResponse;
            import org.slf4j.Logger;
            import org.slf4j.LoggerFactory;
            import org.springframework.beans.factory.annotation.Value;
            import org.springframework.stereotype.Component;
            import org.springframework.util.StringUtils;

            import java.io.UnsupportedEncodingException;
            import java.net.URLEncoder;
            import java.security.Key;
            import java.util.Base64;
            import java.util.Date;

            @Component
            public class JwtUtil {
                // Header KEY ê°’
                public static final String AUTHORIZATION_HEADER = "Authorization";
                // ì‚¬ìš©ì ê¶Œí•œ ê°’ì˜ KEY
                public static final String AUTHORIZATION_KEY = "auth";
                // Token ì‹ë³„ì
                public static final String BEARER_PREFIX = "Bearer ";
                // í† í° ë§Œë£Œì‹œê°„
                private final long TOKEN_TIME = 60 * 60 * 1000L; // 60ë¶„

                @Value("${jwt.secret.key}") // Base64 Encode í•œ SecretKey
                private String secretKey;
                private Key key;
                private final SignatureAlgorithm signatureAlgorithm = SignatureAlgorithm.HS256;

                // ë¡œê·¸ ì„¤ì •
                public static final Logger logger = LoggerFactory.getLogger("JWT ê´€ë ¨ ë¡œê·¸");

                @PostConstruct
                public void init() {
                    byte[] bytes = Base64.getDecoder().decode(secretKey);
                    key = Keys.hmacShaKeyFor(bytes);
                }

                // í† í° ìƒì„±
                public String createToken(String username, UserRoleEnum role) {
                    Date date = new Date();

                    return BEARER_PREFIX +
                            Jwts.builder()
                                    .setSubject(username) // ì‚¬ìš©ì ì‹ë³„ìê°’(ID)
                                    .claim(AUTHORIZATION_KEY, role) // ì‚¬ìš©ì ê¶Œí•œ
                                    .setExpiration(new Date(date.getTime() + TOKEN_TIME)) // ë§Œë£Œ ì‹œê°„
                                    .setIssuedAt(date) // ë°œê¸‰ì¼
                                    .signWith(key, signatureAlgorithm) // ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜
                                    .compact();
                }

                // JWT Cookie ì— ì €ì¥
                public void addJwtToCookie(String token, HttpServletResponse res) {
                    try {
                        token = URLEncoder.encode(token, "utf-8").replaceAll("\\+", "%20"); // Cookie Value ì—ëŠ” ê³µë°±ì´ ë¶ˆê°€ëŠ¥í•´ì„œ encoding ì§„í–‰

                        Cookie cookie = new Cookie(AUTHORIZATION_HEADER, token); // Name-Value
                        cookie.setPath("/");

                        // Response ê°ì²´ì— Cookie ì¶”ê°€
                        res.addCookie(cookie);
                    } catch (UnsupportedEncodingException e) {
                        logger.error(e.getMessage());
                    }
                }

                // JWT í† í° substring
                public String substringToken(String tokenValue) {
                    if (StringUtils.hasText(tokenValue) && tokenValue.startsWith(BEARER_PREFIX)) {
                        return tokenValue.substring(7);
                    }
                    logger.error("Not Found Token");
                    throw new NullPointerException("Not Found Token");
                }

                // í† í° ê²€ì¦
                public boolean validateToken(String token) {
                    try {
                        Jwts.parserBuilder().setSigningKey(key).build().parseClaimsJws(token);
                        return true;
                    } catch (SecurityException | MalformedJwtException | SignatureException e) {
                        logger.error("Invalid JWT signature, ìœ íš¨í•˜ì§€ ì•ŠëŠ” JWT ì„œëª… ì…ë‹ˆë‹¤.");
                    } catch (ExpiredJwtException e) {
                        logger.error("Expired JWT token, ë§Œë£Œëœ JWT token ì…ë‹ˆë‹¤.");
                    } catch (UnsupportedJwtException e) {
                        logger.error("Unsupported JWT token, ì§€ì›ë˜ì§€ ì•ŠëŠ” JWT í† í° ì…ë‹ˆë‹¤.");
                    } catch (IllegalArgumentException e) {
                        logger.error("JWT claims is empty, ì˜ëª»ëœ JWT í† í° ì…ë‹ˆë‹¤.");
                    }
                    return false;
                }

                // í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                public Claims getUserInfoFromToken(String token) {
                    return Jwts.parserBuilder().setSigningKey(key).build().parseClaimsJws(token).getBody();
                }
            }
            ```

- JWT í…ŒìŠ¤íŠ¸
    - [ì½”ë“œ ìŠ¤ë‹ˆí«] JWT í…ŒìŠ¤íŠ¸

        ```java
        @GetMapping("/create-jwt")
        public String createJwt(HttpServletResponse res) {
            // Jwt ìƒì„±
            String token = jwtUtil.createToken("Robbie", UserRoleEnum.USER);

            // Jwt ì¿ í‚¤ ì €ì¥
            jwtUtil.addJwtToCookie(token, res);

            return "createJwt : " + token;
        }

        @GetMapping("/get-jwt")
        public String getJwt(@CookieValue(JwtUtil.AUTHORIZATION_HEADER) String tokenValue) {
            // JWT í† í° substring
            String token = jwtUtil.substringToken(tokenValue);

            // í† í° ê²€ì¦
            if(!jwtUtil.validateToken(token)){
                throw new IllegalArgumentException("Token Error");
            }

            // í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            Claims info = jwtUtil.getUserInfoFromToken(token);
            // ì‚¬ìš©ì username
            String username = info.getSubject();
            System.out.println("username = " + username);
            // ì‚¬ìš©ì ê¶Œí•œ
            String authority = (String) info.get(JwtUtil.AUTHORIZATION_KEY);
            System.out.println("authority = " + authority);

            return "getJwt : " + username + ", " + authority;
        }
        ```