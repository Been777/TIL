# ë‚´ì¼ë°°ì›€ìº í”„ 240605 TIL
Java 37ì¼ì°¨
ì‚¬ìš©ì ê´€ë¦¬í•˜ê¸° (10~12)
-------------------------------------------------------------------------------

## 10. 'Spring Security' í”„ë ˆì„ì›Œí¬
- Spring Security ì ìš©
    ğŸ‘‰ 'Spring Security' í”„ë ˆì„ì›Œí¬ëŠ” Spring ì„œë²„ì— í•„ìš”í•œ ì¸ì¦ ë° ì¸ê°€ë¥¼ ìœ„í•´ ë§ì€ ê¸°ëŠ¥ì„ ì œê³µí•´ ì¤Œìœ¼ë¡œì¨ ê°œë°œì˜ ìˆ˜ê³ ë¥¼ ëœì–´ ì¤ë‹ˆë‹¤. ë§ˆì¹˜ 'Spring' í”„ë ˆì„ì›Œí¬ê°€ ì›¹ ì„œë²„ êµ¬í˜„ì— í¸ì˜ë¥¼ ì œê³µí•´ ì£¼ëŠ” ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤.
    - 'Spring Security' í”„ë ˆì„ì›Œí¬ ì¶”ê°€

        ```groovy
        // Security
        implementation 'org.springframework.boot:spring-boot-starter-security'
        ```

        - ì´ë¯¸ ì¶”ê°€ë˜ì–´ìˆìŠµë‹ˆë‹¤.
    - 'Spring Security' í™œì„±í™”
        - Spring Security ì œì™¸ í•´ì œ

            ```java
            @SpringBootApplication
            public class SpringAuthApplication {

            	public static void main(String[] args) {
            		SpringApplication.run(SpringAuthApplication.class, args);
            	}

            }
            ```

        - 'Spring Security' ì„¤ì •
            - **[ì½”ë“œ ìŠ¤ë‹ˆí«]  WebSecurityConfig**

                ```java
                package com.sparta.springauth.config;

                import org.springframework.boot.autoconfigure.security.servlet.PathRequest;
                import org.springframework.context.annotation.Bean;
                import org.springframework.context.annotation.Configuration;
                import org.springframework.security.config.Customizer;
                import org.springframework.security.config.annotation.web.builders.HttpSecurity;
                import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
                import org.springframework.security.web.SecurityFilterChain;

                @Configuration
                @EnableWebSecurity // Spring Security ì§€ì›ì„ ê°€ëŠ¥í•˜ê²Œ í•¨
                public class WebSecurityConfig {

                    @Bean
                    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
                        // CSRF ì„¤ì •
                        http.csrf((csrf) -> csrf.disable());

                        http.authorizeHttpRequests((authorizeHttpRequests) ->
                                authorizeHttpRequests
                                        .requestMatchers(PathRequest.toStaticResources().atCommonLocations()).permitAll() // resources ì ‘ê·¼ í—ˆìš© ì„¤ì •
                                        .anyRequest().authenticated() // ê·¸ ì™¸ ëª¨ë“  ìš”ì²­ ì¸ì¦ì²˜ë¦¬
                        );

                        // ë¡œê·¸ì¸ ì‚¬ìš©
                        http.formLogin(Customizer.withDefaults());

                        return http.build();
                    }
                }
                ```

        - LoggingFilter, AuthFilter ë“±ë¡ í•´ì œ
            - **LoggingFilter**

                ```java
                @Slf4j(topic = "LoggingFilter")
                //@Component
                @Order(1)
                public class LoggingFilter implements Filter {
                    @Override
                    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
                        // ì „ì²˜ë¦¬
                        HttpServletRequest httpServletRequest = (HttpServletRequest) request;
                        String url = httpServletRequest.getRequestURI();
                        log.info(url);

                        chain.doFilter(request, response); // ë‹¤ìŒ Filter ë¡œ ì´ë™

                        // í›„ì²˜ë¦¬
                        log.info("ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì™„ë£Œ");
                    }
                }
                ```

            - **AuthFilter**
                ```java
                @Slf4j(topic = "AuthFilter")
                //@Component
                @Order(2)
                public class AuthFilter implements Filter {

                    private final UserRepository userRepository;
                    private final JwtUtil jwtUtil;

                    public AuthFilter(UserRepository userRepository, JwtUtil jwtUtil) {
                        this.userRepository = userRepository;
                        this.jwtUtil = jwtUtil;
                    }

                    @Override
                    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
                        HttpServletRequest httpServletRequest = (HttpServletRequest) request;
                        String url = httpServletRequest.getRequestURI();

                        if (StringUtils.hasText(url) &&
                                (url.startsWith("/api/user") || url.startsWith("/css") || url.startsWith("/js"))
                        ) {
                            // íšŒì›ê°€ì…, ë¡œê·¸ì¸ ê´€ë ¨ API ëŠ” ì¸ì¦ í•„ìš”ì—†ì´ ìš”ì²­ ì§„í–‰
                            chain.doFilter(request, response); // ë‹¤ìŒ Filter ë¡œ ì´ë™
                        } else {
                            // ë‚˜ë¨¸ì§€ API ìš”ì²­ì€ ì¸ì¦ ì²˜ë¦¬ ì§„í–‰
                            // í† í° í™•ì¸
                            String tokenValue = jwtUtil.getTokenFromRequest(httpServletRequest);

                            if (StringUtils.hasText(tokenValue)) { // í† í°ì´ ì¡´ì¬í•˜ë©´ ê²€ì¦ ì‹œì‘
                                // JWT í† í° substring
                                String token = jwtUtil.substringToken(tokenValue);

                                // í† í° ê²€ì¦
                                if (!jwtUtil.validateToken(token)) {
                                    throw new IllegalArgumentException("Token Error");
                                }

                                // í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                                Claims info = jwtUtil.getUserInfoFromToken(token);

                                User user = userRepository.findByUsername(info.getSubject()).orElseThrow(() ->
                                        new NullPointerException("Not Found User")
                                );

                                request.setAttribute("user", user);
                                chain.doFilter(request, response); // ë‹¤ìŒ Filter ë¡œ ì´ë™
                            } else {
                                throw new IllegalArgumentException("Not Found Token");
                            }
                        }
                    }

                }
                ```

    - CSRF
        ğŸ”¥ CSRFë€?
        - **CSRF(ì‚¬ì´íŠ¸ ê°„ ìš”ì²­ ìœ„ì¡°, Cross-site request forgery)**
            - ê³µê²©ìê°€ ì¸ì¦ëœ ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ì¿ í‚¤ì˜ ì„¸ì…˜ ì •ë³´ë¥¼ í™œìš©í•˜ì—¬ ì›¹ ì„œë²„ì— ì‚¬ìš©ìê°€ ì˜ë„í•˜ì§€ ì•Šì€ ìš”ì²­ì„ ì „ë‹¬í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
            - CSRF ì„¤ì •ì´ ë˜ì–´ìˆëŠ” ê²½ìš° html ì—ì„œ CSRF í† í° ê°’ì„ ë„˜ê²¨ì£¼ì–´ì•¼ ìš”ì²­ì„ ìˆ˜ì‹  ê°€ëŠ¥í•©ë‹ˆë‹¤.
            - ì¿ í‚¤ ê¸°ë°˜ì˜ ì·¨ì•½ì ì„ ì´ìš©í•œ ê³µê²© ì´ê¸° ë•Œë¬¸ì— REST ë°©ì‹ì˜ API ì—ì„œëŠ” disable ê°€ëŠ¥í•©ë‹ˆë‹¤.
            - POST ìš”ì²­ë§ˆë‹¤ ì²˜ë¦¬í•´ ì£¼ëŠ” ëŒ€ì‹  **CSRF protection ì„ disable** í•˜ê² ìŠµë‹ˆë‹¤.
                - `http.csrf((csrf) -> csrf.disable());`

- Spring Securityì˜ default ë¡œê·¸ì¸ ê¸°ëŠ¥
    - Username: **user**
    - Password: S*pring ë¡œê·¸ í™•ì¸* (ì„œë²„ ì‹œì‘ ì‹œë§ˆë‹¤ ë³€ê²½ë¨)

- Spring Security ì´í•´í•˜ê¸°
    ### Spring Security - Filter Chain
    - Springì—ì„œ ëª¨ë“  í˜¸ì¶œì€ DispatcherServletì„ í†µê³¼í•˜ê²Œ ë˜ê³  ì´í›„ì— ê° ìš”ì²­ì„ ë‹´ë‹¹í•˜ëŠ” Controller ë¡œ ë¶„ë°°ë©ë‹ˆë‹¤.
    - ì´ ë•Œ, ê° ìš”ì²­ì— ëŒ€í•´ì„œ ê³µí†µì ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼í•  í•„ìš”ê°€ ìˆì„ ë•Œ DispatcherServlet ì´ì „ì— ë‹¨ê³„ê°€ í•„ìš”í•˜ë©° ì´ê²ƒì´ Filter ì…ë‹ˆë‹¤.
    - Spring Securityë„ ì¸ì¦ ë° ì¸ê°€ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ Filterë¥¼ ì‚¬ìš©í•˜ëŠ”ë°
        - Spring SecurityëŠ” FilterChainProxyë¥¼ í†µí•´ì„œ ìƒì„¸ë¡œì§ì„ êµ¬í˜„í•˜ê³  ìˆìŠµë‹ˆë‹¤.

    ### Form Login ê¸°ë°˜ì€ ì¸ì¦
    - Form Login ê¸°ë°˜ ì¸ì¦ì€ ì¸ì¦ì´ í•„ìš”í•œ URL ìš”ì²­ì´ ë“¤ì–´ì™”ì„ ë•Œ ì¸ì¦ì´ ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¥¼ ë°˜í™˜í•˜ëŠ” í˜•íƒœì…ë‹ˆë‹¤.

    ### UsernamePasswordAuthenticationFilter
    - UsernamePasswordAuthenticationFilterëŠ” Spring Securityì˜ í•„í„°ì¸ AbstractAuthenticationProcessingFilterë¥¼ ìƒì†í•œ Filterì…ë‹ˆë‹¤.
    - ê¸°ë³¸ì ìœ¼ë¡œ Form Login ê¸°ë°˜ì„ ì‚¬ìš©í•  ë•Œ username ê³¼ password í™•ì¸í•˜ì—¬ ì¸ì¦í•©ë‹ˆë‹¤.
    - ì¸ì¦ ê³¼ì •
        1. ì‚¬ìš©ìê°€ usernameê³¼ passwordë¥¼ ì œì¶œí•˜ë©´ UsernamePasswordAuthenticationFilterëŠ” ì¸ì¦ëœ ì‚¬ìš©ìì˜ ì •ë³´ê°€ ë‹´ê¸°ëŠ” ì¸ì¦ ê°ì²´ì¸ Authenticationì˜ ì¢…ë¥˜ ì¤‘ í•˜ë‚˜ì¸  UsernamePasswordAuthenticationTokenì„ ë§Œë“¤ì–´ AuthenticationManagerì—ê²Œ ë„˜ê²¨ ì¸ì¦ì„ ì‹œë„í•©ë‹ˆë‹¤.
        2. ì‹¤íŒ¨í•˜ë©´ SecurityContextHolderë¥¼ ë¹„ì›ë‹ˆë‹¤.
        3. ì„±ê³µí•˜ë©´ SecurityContextHolderì— Authenticationë¥¼ ì„¸íŒ…í•©ë‹ˆë‹¤.

    - SecurityContextHolder
        - SecurityContextëŠ” ì¸ì¦ì´ ì™„ë£Œëœ ì‚¬ìš©ìì˜ ìƒì„¸ ì •ë³´(Authentication)ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
        - SecurityContextëŠ” SecurityContextHolder ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

        ```java
        // ì˜ˆì‹œì½”ë“œ
        SecurityContext context = SecurityContextHolder.createEmptyContext();
        Authentication authentication = new UsernamePasswordAuthenticationToken(principal, credentials, authorities);
        context.setAuthentication(authentication); // SecurityContext ì— ì¸ì¦ ê°ì²´ Authentication ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.

        SecurityContextHolder.setContext(context);
        ```

    - Authentication
        - í˜„ì¬ ì¸ì¦ëœ ì‚¬ìš©ìë¥¼ ë‚˜íƒ€ë‚´ë©° SecurityContextì—ì„œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - principal  :  ì‚¬ìš©ìë¥¼ ì‹ë³„í•©ë‹ˆë‹¤.
            - Username/Password ë°©ì‹ìœ¼ë¡œ ì¸ì¦í•  ë•Œ ì¼ë°˜ì ìœ¼ë¡œ UserDetails ì¸ìŠ¤í„´ìŠ¤ì…ë‹ˆë‹¤.
        - credentials : ì£¼ë¡œ ë¹„ë°€ë²ˆí˜¸, ëŒ€ë¶€ë¶„ ì‚¬ìš©ì ì¸ì¦ì— ì‚¬ìš©í•œ í›„ ë¹„ì›ë‹ˆë‹¤.
        - authorities : ì‚¬ìš©ìì—ê²Œ ë¶€ì—¬í•œ ê¶Œí•œì„ GrantedAuthorityë¡œ ì¶”ìƒí™”í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.

        ```java
        <UserDetails>
        @Override
        public Collection<? extends GrantedAuthority> getAuthorities() {
            UserRoleEnum role = user.getRole();
            String authority = role.getAuthority();

            SimpleGrantedAuthority simpleGrantedAuthority = new SimpleGrantedAuthority(authority);
            Collection<GrantedAuthority> authorities = new ArrayList<>();
            authorities.add(simpleGrantedAuthority);

            return authorities;
        }

        Authentication authentication = new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
        ğŸ”¥ UsernamePasswordAuthenticationTokenëŠ” Authenticationì„ implementsí•œ AbstractAuthenticationTokenì˜ í•˜ìœ„ í´ë˜ìŠ¤ë¡œ, ì¸ì¦ê°ì²´ë¥¼ ë§Œë“œëŠ”ë° ì‚¬ìš©ë©ë‹ˆë‹¤.

    - UserDetailsService
        ğŸ”¥ UserDetailsServiceëŠ” username/password ì¸ì¦ë°©ì‹ì„ ì‚¬ìš©í•  ë•Œ ì‚¬ìš©ìë¥¼ ì¡°íšŒí•˜ê³  ê²€ì¦í•œ í›„ UserDetailsë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. Customí•˜ì—¬ Beanìœ¼ë¡œ ë“±ë¡ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

    - UserDetails
        ğŸ”¥ ê²€ì¦ëœ UserDetailsëŠ” UsernamePasswordAuthenticationToken íƒ€ì…ì˜ Authenticationë¥¼ ë§Œë“¤ ë•Œ ì‚¬ìš©ë˜ë©° í•´ë‹¹ ì¸ì¦ê°ì²´ëŠ” SecurityContextHolderì— ì„¸íŒ…ë©ë‹ˆë‹¤. Customí•˜ì—¬ ì‚¬ìš©ê°€ëŠ¥í•©ë‹ˆë‹¤.

## 11. Spring Security : ë¡œê·¸ì¸
- ë¡œê·¸ì¸ ì²˜ë¦¬ ê³¼ì • ì´í•´
    - ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì‚¬ìš© ì „
    - ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì‚¬ìš© í›„
        - Client ì˜ ìš”ì²­ì€ ëª¨ë‘ Spring Security ë¥¼ ê±°ì¹˜ê²Œë©ë‹ˆë‹¤.
        - Spring Security ì—­í• 
            - ì¸ì¦/ì¸ê°€
                1. ì„±ê³µ ì‹œ: Controller ë¡œ Client ìš”ì²­ ì „ë‹¬
                    1. Client ìš”ì²­ + ì‚¬ìš©ì ì •ë³´ (UserDetails)
                2. ì‹¤íŒ¨ ì‹œ: Controller ë¡œ Client ìš”ì²­ ì „ë‹¬ë˜ì§€ ì•ŠìŒ
                    1. Client ì—ê²Œ Error Response ë³´ëƒ„

    - ë¡œê·¸ì¸ ì²˜ë¦¬ ê³¼ì •
        - ìƒì„¸ ì²˜ë¦¬ ê³¼ì • ì„¤ëª…
            1. Client
                1. ë¡œê·¸ì¸ ì‹œë„
                2. ë¡œê·¸ì¸ ì‹œë„í•  username, password ì •ë³´ë¥¼ HTTP body ë¡œ ì „ë‹¬ (POST ìš”ì²­)
                3. ë¡œê·¸ì¸ ì‹œë„ URL ì€ WebSecurityConfig í´ë˜ìŠ¤ì—ì„œ ë³€ê²½ ê°€ëŠ¥
                    - ì•„ë˜ì™€ ê°™ì´ ì„¤ì • ì‹œ "**POST /api/user/login**" ë¡œ ì„¤ì •ë©ë‹ˆë‹¤.

                    ```java
                    @Bean
                    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
                        // CSRF ì„¤ì •
                        http.csrf((csrf) -> csrf.disable());

                        http.authorizeHttpRequests((authorizeHttpRequests) ->
                                authorizeHttpRequests
                                        .requestMatchers(PathRequest.toStaticResources().atCommonLocations()).permitAll() // resources ì ‘ê·¼ í—ˆìš© ì„¤ì •
                                        .anyRequest().authenticated() // ê·¸ ì™¸ ëª¨ë“  ìš”ì²­ ì¸ì¦ì²˜ë¦¬
                        );

                        // ë¡œê·¸ì¸ ì‚¬ìš©
                    	 http.formLogin((formLogin) ->
                                formLogin
                                     // ë¡œê·¸ì¸ ì²˜ë¦¬ (POST /api/user/login)
                                    **.loginProcessingUrl("/api/user/login")**.permitAll()
                        );

                        return http.build();
                    }
                    ```


            2. **ì¸ì¦ ê´€ë¦¬ì** (Authentication Manager)
                1. UserDetailsService ì—ê²Œ username ì„ ì „ë‹¬í•˜ê³  íšŒì›ìƒì„¸ ì •ë³´ë¥¼ ìš”ì²­

            3. UserDetailsService
                1. íšŒì› DB ì—ì„œ íšŒì› ì¡°íšŒ

                    ```java
                    User user = userRepository.findByUsername(username)
                            .orElseThrow(() -> new UsernameNotFoundException("Not Found " + username));
                    ```

                    - íšŒì› ì •ë³´ê°€ ì¡´ì¬í•˜ì§€ ì•Šì„ ì‹œ â†’ Error ë°œìƒ

                2. ì¡°íšŒëœ íšŒì› ì •ë³´(user) ë¥¼ UserDetails ë¡œ ë³€í™˜

                    ```java
                    UserDetails userDetails = new UserDetailsImpl(user)
                    ```

                3. UserDetails ë¥¼ **"ì¸ì¦ ê´€ë¦¬ì"**ì—ê²Œ ì „ë‹¬

            4. "ì¸ì¦ ê´€ë¦¬ì" ê°€ **ì¸ì¦ ì²˜ë¦¬**
                1. ì•„ë˜ 2 ê°œì˜ username, password ì¼ì¹˜ ì—¬ë¶€ í™•ì¸
                    1. Client ê°€ ë¡œê·¸ì¸ ì‹œë„í•œ username, password
                    2. UserDetailsService ê°€ ì „ë‹¬í•´ì¤€ UserDetails ì˜ username, password
                2. password ë¹„êµ ì‹œ
                    1. Client ê°€ ë³´ë‚¸ password ëŠ” í‰ë¬¸ì´ê³ , UserDetails ì˜ password ëŠ” ì•”í˜¸ë¬¸
                    2. Client ê°€ ë³´ë‚¸ password ë¥¼ ì•”í˜¸í™”í•´ì„œ ë¹„êµ
                3. ì¸ì¦ ì„±ê³µ ì‹œ â†’ ì„¸ì…˜ì— ë¡œê·¸ì¸ ì •ë³´ ì €ì¥
                4. ì¸ì¦ ì‹¤íŒ¨ ì‹œ â†’ Error ë°œìƒ

- ë¡œê·¸ì¸ êµ¬í˜„
    1. ë¡œê·¸ì¸ ì²˜ë¦¬ URL ì„¤ì •
        - **[ì½”ë“œ ìŠ¤ë‹ˆí«] WebSecurityConfig**

            ```java
            package com.sparta.springauth.config;

            import org.springframework.boot.autoconfigure.security.servlet.PathRequest;
            import org.springframework.context.annotation.Bean;
            import org.springframework.context.annotation.Configuration;
            import org.springframework.security.config.annotation.web.builders.HttpSecurity;
            import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
            import org.springframework.security.web.SecurityFilterChain;

            @Configuration
            @EnableWebSecurity // Spring Security ì§€ì›ì„ ê°€ëŠ¥í•˜ê²Œ í•¨
            public class WebSecurityConfig {

                @Bean
                public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
                    // CSRF ì„¤ì •
                    http.csrf((csrf) -> csrf.disable());

                    http.authorizeHttpRequests((authorizeHttpRequests) ->
                            authorizeHttpRequests
                                    .requestMatchers(PathRequest.toStaticResources().atCommonLocations()).permitAll() // resources ì ‘ê·¼ í—ˆìš© ì„¤ì •
                                    .requestMatchers("/api/user/**").permitAll() // '/api/user/'ë¡œ ì‹œì‘í•˜ëŠ” ìš”ì²­ ëª¨ë‘ ì ‘ê·¼ í—ˆê°€
                                    .anyRequest().authenticated() // ê·¸ ì™¸ ëª¨ë“  ìš”ì²­ ì¸ì¦ì²˜ë¦¬
                    );

                    // ë¡œê·¸ì¸ ì‚¬ìš©
                    http.formLogin((formLogin) ->
                            formLogin
                                    // ë¡œê·¸ì¸ View ì œê³µ (GET /api/user/login-page)
                                    .loginPage("/api/user/login-page")
                                    // ë¡œê·¸ì¸ ì²˜ë¦¬ (POST /api/user/login)
                                    .loginProcessingUrl("/api/user/login")
                                    // ë¡œê·¸ì¸ ì²˜ë¦¬ í›„ ì„±ê³µ ì‹œ URL
                                    .defaultSuccessUrl("/")
                                    // ë¡œê·¸ì¸ ì²˜ë¦¬ í›„ ì‹¤íŒ¨ ì‹œ URL
                                    .failureUrl("/api/user/login-page?error")
                                    .permitAll()
                    );

                    return http.build();
                }
            }
            ```

        - ìš°ë¦¬ê°€ ì§ì ‘ Filterë¥¼ êµ¬í˜„í•´ì„œ URL ìš”ì²­ì— ë”°ë¥¸ ì¸ê°€ë¥¼ ì„¤ì •í•œë‹¤ë©´ ì½”ë“œê°€ ë§¤ìš° ë³µì¡í•´ì§€ê³  ìœ ì§€ë³´ìˆ˜ ë¹„ìš©ì´ ë§ì´ ë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - Spring Securityë¥¼ ì‚¬ìš©í•˜ë©´ ì´ëŸ¬í•œ ì¸ê°€ ì²˜ë¦¬ê°€ êµ‰ì¥íˆ í¸í•´ì§‘ë‹ˆë‹¤.
            - `requestMatchers("/api/user/**").permitAll()`
                - ì´ ìš”ì²­ë“¤ì€ ë¡œê·¸ì¸, íšŒì›ê°€ì… ê´€ë ¨ ìš”ì²­ì´ê¸° ë•Œë¬¸ì— ë¹„íšŒì›/íšŒì› ìƒê´€ì—†ì´ ëˆ„êµ¬ë‚˜ ì ‘ê·¼ì´ ê°€ëŠ¥í•´ì•¼í•©ë‹ˆë‹¤.
                - ì´ë ‡ê²Œ ì¸ì¦ì´ í•„ìš” ì—†ëŠ” URLë“¤ì„ ê°„í¸í•˜ê²Œ í—ˆê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            - `anyRequest().authenticated()`
                - ì¸ì¦ì´ í•„ìš”í•œ URLë“¤ë„ ê°„í¸í•˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    2. DBì˜ íšŒì› ì •ë³´ ì¡°íšŒ â†’  Spring Securityì˜ "**ì¸ì¦ ê´€ë¦¬ì"** ì—ê²Œ ****ì „ë‹¬
        1. UserDetailsService êµ¬í˜„
            1. UserDetailsService ì¸í„°í˜ì´ìŠ¤ â†’ **UserDetailsServiceImpl**
            - **[ì½”ë“œ ìŠ¤ë‹ˆí«] security > UserDetailsServiceImpl**

                ```java
                package com.sparta.springauth.security;

                import com.sparta.springauth.entity.User;
                import com.sparta.springauth.repository.UserRepository;
                import org.springframework.security.core.userdetails.UserDetails;
                import org.springframework.security.core.userdetails.UserDetailsService;
                import org.springframework.security.core.userdetails.UsernameNotFoundException;
                import org.springframework.stereotype.Service;

                @Service
                public class UserDetailsServiceImpl implements UserDetailsService {

                    private final UserRepository userRepository;

                    public UserDetailsServiceImpl(UserRepository userRepository) {
                        this.userRepository = userRepository;
                    }

                		@Override
                    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
                        User user = userRepository.findByUsername(username)
                                .orElseThrow(() -> new UsernameNotFoundException("Not Found " + username));

                        return new UserDetailsImpl(user);
                    }
                }
                ```

        2. UserDetails êµ¬í˜„
            1. UserDetails ì¸í„°í˜ì´ìŠ¤ â†’ **UserDetailsImpl**
            - **[ì½”ë“œ ìŠ¤ë‹ˆí«] security > UserDetailsImpl**

                ```java
                package com.sparta.springauth.security;

                import com.sparta.springauth.entity.User;
                import com.sparta.springauth.entity.UserRoleEnum;
                import org.springframework.security.core.GrantedAuthority;
                import org.springframework.security.core.authority.SimpleGrantedAuthority;
                import org.springframework.security.core.userdetails.UserDetails;

                import java.util.ArrayList;
                import java.util.Collection;

                public class UserDetailsImpl implements UserDetails {

                    private final User user;

                    public UserDetailsImpl(User user) {
                        this.user = user;
                    }

                    public User getUser() {
                        return user;
                    }

                    @Override
                    public String getPassword() {
                        return user.getPassword();
                    }

                    @Override
                    public String getUsername() {
                        return user.getUsername();
                    }

                    @Override
                    public Collection<? extends GrantedAuthority> getAuthorities() {
                        UserRoleEnum role = user.getRole();
                        String authority = role.getAuthority();

                        SimpleGrantedAuthority simpleGrantedAuthority = new SimpleGrantedAuthority(authority);
                        Collection<GrantedAuthority> authorities = new ArrayList<>();
                        authorities.add(simpleGrantedAuthority);

                        return authorities;
                    }

                    @Override
                    public boolean isAccountNonExpired() {
                        return true;
                    }

                    @Override
                    public boolean isAccountNonLocked() {
                        return true;
                    }

                    @Override
                    public boolean isCredentialsNonExpired() {
                        return true;
                    }

                    @Override
                    public boolean isEnabled() {
                        return true;
                    }
                }
                ```

    - UserDetailsServiceì™€ UserDetailsë¥¼ ì§ì ‘ êµ¬í˜„í•´ì„œ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ Securityì˜ default ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì§€ ì•Šê² ë‹¤ëŠ” ì„¤ì •ì´ ë˜ì–´ Securityì˜ passwordë¥¼ ë” ì´ìƒ ì œê³µí•˜ì§€ ì•ŠëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - POST "/api/user/login" ì„ ë¡œê·¸ì¸ ì¸ì¦ URLë¡œ ì„¤ì •í–ˆê¸° ë•Œë¬¸ì— ì´ì œ í•´ë‹¹ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ìš°ë¦¬ê°€ ì§ì ‘ êµ¬í˜„í•œ UserDetailsServiceë¥¼ í†µí•´ ì¸ì¦ í™•ì¸ ì‘ì—…ì´ ì´ë¤„ì§€ê³  ì¸ì¦ ê°ì²´ì— ì§ì ‘ êµ¬í˜„í•œ UserDetailsê°€ ë‹´ê¸°ê²Œ ë©ë‹ˆë‹¤.

- **@AuthenticationPrincipal**

    ```java
    @Controller
    @RequestMapping("/api")
    public class ProductController {

        @GetMapping("/products")
        public String getProducts(@AuthenticationPrincipal UserDetailsImpl userDetails) {
            // Authentication ì˜ Principal ì— ì €ì¥ëœ UserDetailsImpl ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
            User user =  userDetails.getUser();
            System.out.println("user.getUsername() = " + user.getUsername());

           return "redirect:/";
        }
    }
    ```

    - @AuthenticationPrincipal
        - Authenticationì˜ Principal ì— ì €ì¥ëœ UserDetailsImplì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - UserDetailsImplì— ì €ì¥ëœ ì¸ì¦ëœ ì‚¬ìš©ìì¸ User ê°ì²´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - @AuthenticationPrincipal ì‚¬ìš©í•´ì„œ ë©”ì¸ í˜ì´ì§€ ì‚¬ìš©ì ì´ë¦„ ë°˜ì˜í•˜ê¸°

        ```java
        @Controller
        public class HomeController {
            @GetMapping("/")
            public String home(Model model, @AuthenticationPrincipal UserDetailsImpl userDetails) {
                // í˜ì´ì§€ ë™ì  ì²˜ë¦¬ : ì‚¬ìš©ì ì´ë¦„
                model.addAttribute("username", userDetails.getUser().getUsername());

                return "index";
            }
        }
        ```

## 12. Spring Security : JWT ë¡œê·¸ì¸
- Security Filter ìˆœì„œ í™•ì¸í•˜ê¸°
- ë¡œê·¸ì¸ í˜ì´ì§€ ìˆ˜ì •
    - [ì½”ë“œ ìŠ¤ë‹ˆí«] login.html

        ```html
        <!DOCTYPE html>
        <html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport"
                content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
          <meta http-equiv="X-UA-Compatible" content="ie=edge">
          <link rel="preconnect" href="https://fonts.gstatic.com">
          <link rel="stylesheet" type="text/css" href="/css/style.css">
          <script src="https://code.jquery.com/jquery-3.7.0.min.js"
                  integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
          <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
          <meta charset="UTF-8">
          <title>ë¡œê·¸ì¸ í˜ì´ì§€</title>
        </head>
        <body>
        <div id="login-form">
          <div id="login-title">Log into Select Shop</div>
          <br>
          <br>
          <button id="login-id-btn" onclick="location.href='/api/user/signup'">
            íšŒì› ê°€ì…í•˜ê¸°
          </button>
          <div>
            <div class="login-id-label">ì•„ì´ë””</div>
            <input type="text" name="username" id="username" class="login-input-box">

            <div class="login-id-label">ë¹„ë°€ë²ˆí˜¸</div>
            <input type="password" name="password" id="password" class="login-input-box">

            <button id="login-id-submit" onclick="onLogin()">ë¡œê·¸ì¸</button>
          </div>
          <div id="login-failed" style="display: none" class="alert alert-danger" role="alert">ë¡œê·¸ì¸ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.</div>
        </div>
        </body>
        <script>
        	$(document).ready(function () {
            // í† í° ì‚­ì œ
            Cookies.remove('Authorization', {path: '/'});
          });

          const host = 'http://' + window.location.host;

          const href = location.href;
          const queryString = href.substring(href.indexOf("?")+1)
          if (queryString === 'error') {
            const errorDiv = document.getElementById('login-failed');
            errorDiv.style.display = 'block';
          }

          function onLogin() {
            let username = $('#username').val();
            let password = $('#password').val();

            $.ajax({
              type: "POST",
              url: `/api/user/login`,
              contentType: "application/json",
              data: JSON.stringify({username: username, password: password}),
            })
                    .done(function (res, status, xhr) {
                      window.location.href = host;
                    })
                    .fail(function (xhr, textStatus, errorThrown) {
                      console.log('statusCode: ' + xhr.status);
                      window.location.href = host + '/api/user/login-page?error'
                    });
          }
        </script>
        </html>
        ```

- JWT ì¸ì¦ ì²˜ë¦¬ (Filter)
    - **JwtAuthenticationFilter** : ë¡œê·¸ì¸ ì§„í–‰ ë° JWT ìƒì„±
        - [ì½”ë“œ ìŠ¤ë‹ˆí«] **JwtAuthenticationFilter**

            ```java
            package com.sparta.springauth.jwt;

            import com.fasterxml.jackson.databind.ObjectMapper;
            import com.sparta.springauth.dto.LoginRequestDto;
            import com.sparta.springauth.entity.UserRoleEnum;
            import com.sparta.springauth.security.UserDetailsImpl;
            import jakarta.servlet.FilterChain;
            import jakarta.servlet.ServletException;
            import jakarta.servlet.http.HttpServletRequest;
            import jakarta.servlet.http.HttpServletResponse;
            import lombok.extern.slf4j.Slf4j;
            import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
            import org.springframework.security.core.Authentication;
            import org.springframework.security.core.AuthenticationException;
            import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

            import java.io.IOException;

            @Slf4j(topic = "ë¡œê·¸ì¸ ë° JWT ìƒì„±")
            public class JwtAuthenticationFilter extends UsernamePasswordAuthenticationFilter {
                private final JwtUtil jwtUtil;

                public JwtAuthenticationFilter(JwtUtil jwtUtil) {
                    this.jwtUtil = jwtUtil;
                    setFilterProcessesUrl("/api/user/login");
                }

                @Override
                public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException {
                    log.info("ë¡œê·¸ì¸ ì‹œë„");
                    try {
                        LoginRequestDto requestDto = new ObjectMapper().readValue(request.getInputStream(), LoginRequestDto.class);

                        return getAuthenticationManager().authenticate(
                                new UsernamePasswordAuthenticationToken(
                                        requestDto.getUsername(),
                                        requestDto.getPassword(),
                                        null
                                )
                        );
                    } catch (IOException e) {
                        log.error(e.getMessage());
                        throw new RuntimeException(e.getMessage());
                    }
                }

                @Override
                protected void successfulAuthentication(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication authResult) throws IOException, ServletException {
                    log.info("ë¡œê·¸ì¸ ì„±ê³µ ë° JWT ìƒì„±");
                    String username = ((UserDetailsImpl) authResult.getPrincipal()).getUsername();
                    UserRoleEnum role = ((UserDetailsImpl) authResult.getPrincipal()).getUser().getRole();

                    String token = jwtUtil.createToken(username, role);
                    jwtUtil.addJwtToCookie(token, response);
                }

                @Override
                protected void unsuccessfulAuthentication(HttpServletRequest request, HttpServletResponse response, AuthenticationException failed) throws IOException, ServletException {
                    log.info("ë¡œê·¸ì¸ ì‹¤íŒ¨");
                    response.setStatus(401);
                }
            }
            ```

- JWT ì¸ê°€ ì²˜ë¦¬ (Filter)
    - **JwtAuthorizationFilter** : APIì— ì „ë‹¬ë˜ëŠ” JWT ìœ íš¨ì„± ê²€ì¦ ë° ì¸ê°€ ì²˜ë¦¬
        - [ì½”ë“œ ìŠ¤ë‹ˆí«] **JwtAuthorizationFilter**

            ```java
            package com.sparta.springauth.jwt;

            import com.sparta.springauth.security.UserDetailsServiceImpl;
            import io.jsonwebtoken.Claims;
            import jakarta.servlet.FilterChain;
            import jakarta.servlet.ServletException;
            import jakarta.servlet.http.HttpServletRequest;
            import jakarta.servlet.http.HttpServletResponse;
            import lombok.extern.slf4j.Slf4j;
            import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
            import org.springframework.security.core.Authentication;
            import org.springframework.security.core.context.SecurityContext;
            import org.springframework.security.core.context.SecurityContextHolder;
            import org.springframework.security.core.userdetails.UserDetails;
            import org.springframework.util.StringUtils;
            import org.springframework.web.filter.OncePerRequestFilter;

            import java.io.IOException;

            @Slf4j(topic = "JWT ê²€ì¦ ë° ì¸ê°€")
            public class JwtAuthorizationFilter extends OncePerRequestFilter {

                private final JwtUtil jwtUtil;
                private final UserDetailsServiceImpl userDetailsService;

                public JwtAuthorizationFilter(JwtUtil jwtUtil, UserDetailsServiceImpl userDetailsService) {
                    this.jwtUtil = jwtUtil;
                    this.userDetailsService = userDetailsService;
                }

                @Override
                protected void doFilterInternal(HttpServletRequest req, HttpServletResponse res, FilterChain filterChain) throws ServletException, IOException {

                    String tokenValue = jwtUtil.getTokenFromRequest(req);

                    if (StringUtils.hasText(tokenValue)) {
                        // JWT í† í° substring
                        tokenValue = jwtUtil.substringToken(tokenValue);
                        log.info(tokenValue);

                        if (!jwtUtil.validateToken(tokenValue)) {
                            log.error("Token Error");
                            return;
                        }

                        Claims info = jwtUtil.getUserInfoFromToken(tokenValue);

                        try {
                             setAuthentication(info.getSubject());
                        } catch (Exception e) {
                            log.error(e.getMessage());
                            return;
                        }
                    }

                    filterChain.doFilter(req, res);
                }

                // ì¸ì¦ ì²˜ë¦¬
                public void setAuthentication(String username) {
                    SecurityContext context = SecurityContextHolder.createEmptyContext();
                    Authentication authentication = createAuthentication(username);
                    context.setAuthentication(authentication);

                    SecurityContextHolder.setContext(context);
                }

                // ì¸ì¦ ê°ì²´ ìƒì„±
                private Authentication createAuthentication(String username) {
                    UserDetails userDetails = userDetailsService.loadUserByUsername(username);
                    return new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
                }
            }
            ```

- **WebSecurityConfig í•„í„° ë“±ë¡**
    - [ì½”ë“œ ìŠ¤ë‹ˆí«] **WebSecurityConfig**

        ```java
        package com.sparta.springauth.config;

        import com.sparta.springauth.jwt.JwtAuthorizationFilter;
        import com.sparta.springauth.jwt.JwtAuthenticationFilter;
        import com.sparta.springauth.jwt.JwtUtil;
        import com.sparta.springauth.security.UserDetailsServiceImpl;
        import org.springframework.boot.autoconfigure.security.servlet.PathRequest;
        import org.springframework.context.annotation.Bean;
        import org.springframework.context.annotation.Configuration;
        import org.springframework.security.authentication.AuthenticationManager;
        import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
        import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
        import org.springframework.security.config.annotation.web.builders.HttpSecurity;
        import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
        import org.springframework.security.config.http.SessionCreationPolicy;
        import org.springframework.security.web.SecurityFilterChain;
        import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

        @Configuration
        @EnableWebSecurity // Spring Security ì§€ì›ì„ ê°€ëŠ¥í•˜ê²Œ í•¨
        public class WebSecurityConfig {

            private final JwtUtil jwtUtil;
            private final UserDetailsServiceImpl userDetailsService;
            private final AuthenticationConfiguration authenticationConfiguration;

            public WebSecurityConfig(JwtUtil jwtUtil, UserDetailsServiceImpl userDetailsService, AuthenticationConfiguration authenticationConfiguration) {
                this.jwtUtil = jwtUtil;
                this.userDetailsService = userDetailsService;
                this.authenticationConfiguration = authenticationConfiguration;
            }

            @Bean
            public AuthenticationManager authenticationManager(AuthenticationConfiguration configuration) throws Exception {
                return configuration.getAuthenticationManager();
            }

            @Bean
            public JwtAuthenticationFilter jwtAuthenticationFilter() throws Exception {
                JwtAuthenticationFilter filter = new JwtAuthenticationFilter(jwtUtil);
                filter.setAuthenticationManager(authenticationManager(authenticationConfiguration));
                return filter;
            }

            @Bean
            public JwtAuthorizationFilter jwtAuthorizationFilter() {
                return new JwtAuthorizationFilter(jwtUtil, userDetailsService);
            }

            @Bean
            public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
                // CSRF ì„¤ì •
                http.csrf((csrf) -> csrf.disable());

                // ê¸°ë³¸ ì„¤ì •ì¸ Session ë°©ì‹ì€ ì‚¬ìš©í•˜ì§€ ì•Šê³  JWT ë°©ì‹ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì„¤ì •
                http.sessionManagement((sessionManagement) ->
                        sessionManagement.sessionCreationPolicy(SessionCreationPolicy.STATELESS)
                );

                http.authorizeHttpRequests((authorizeHttpRequests) ->
                        authorizeHttpRequests
                                .requestMatchers(PathRequest.toStaticResources().atCommonLocations()).permitAll() // resources ì ‘ê·¼ í—ˆìš© ì„¤ì •
                                .requestMatchers("/api/user/**").permitAll() // '/api/user/'ë¡œ ì‹œì‘í•˜ëŠ” ìš”ì²­ ëª¨ë‘ ì ‘ê·¼ í—ˆê°€
                                .anyRequest().authenticated() // ê·¸ ì™¸ ëª¨ë“  ìš”ì²­ ì¸ì¦ì²˜ë¦¬
                );

                http.formLogin((formLogin) ->
                        formLogin
                                .loginPage("/api/user/login-page").permitAll()
                );

                // í•„í„° ê´€ë¦¬
                http.addFilterBefore(jwtAuthorizationFilter(), JwtAuthenticationFilter.class);
                http.addFilterBefore(jwtAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class);

                return http.build();
            }
        }
        ```