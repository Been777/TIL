# ë‚´ì¼ë°°ì›€ìº í”„ 240523 TIL
Java 26ì¼ì°¨
JPA CORE(~9)
-------------------------------------------------------------------------------

## Entityì˜ ìƒíƒœ
- ë¹„ì˜ì†(**Transient**)
    ```java
    Memo memo = new Memo(); // ë¹„ì˜ì† ìƒíƒœ
    memo.setId(1L);
    memo.setUsername("Robbie");
    memo.setContents("ë¹„ì˜ì†ê³¼ ì˜ì† ìƒíƒœ");
    ```
    - ì‰½ê²Œ ë§í•˜ìë©´ **new** ì—°ì‚°ìë¥¼ í†µí•´ ì¸ìŠ¤í„´ìŠ¤í™” ëœ Entity ê°ì²´ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.
    - ì•„ì§ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— JPAì˜ ê´€ë¦¬ë¥¼ ë°›ì§€ ì•ŠìŠµë‹ˆë‹¤.

- ì˜ì†(**Managed**)
    ```java
    em.persist(memo);
    ```
    - **persist(entity)** : ë¹„ì˜ì† Entityë¥¼ EntityManagerë¥¼ í†µí•´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥í•˜ì—¬ ê´€ë¦¬ë˜ê³  ìˆëŠ” ìƒíƒœë¡œ ë§Œë“­ë‹ˆë‹¤.
    ```sql
    @Test
    @DisplayName("ë¹„ì˜ì†ê³¼ ì˜ì† ìƒíƒœ")
    void test1() {
        EntityTransaction et = em.getTransaction();

        et.begin();

        try {

            Memo memo = new Memo(); // ë¹„ì˜ì† ìƒíƒœ
            memo.setId(1L);
            memo.setUsername("Robbie");
            memo.setContents("ë¹„ì˜ì†ê³¼ ì˜ì† ìƒíƒœ");

            em.persist(memo);

            et.commit();

        } catch (Exception ex) {
            ex.printStackTrace();
            et.rollback();
        } finally {
            em.close();
        }

        emf.close();
    }
    ``
    - [ì½”ë“œ ìŠ¤ë‹ˆí«] ë¹„ì˜ì†ê³¼ ì˜ì† ìƒíƒœ

        ```java
        @Test
        @DisplayName("ë¹„ì˜ì†ê³¼ ì˜ì† ìƒíƒœ")
        void test1() {
            EntityTransaction et = em.getTransaction();

            et.begin();

            try {

                Memo memo = new Memo(); // ë¹„ì˜ì† ìƒíƒœ
                memo.setId(1L);
                memo.setUsername("Robbie");
                memo.setContents("ë¹„ì˜ì†ê³¼ ì˜ì† ìƒíƒœ");

                em.persist(memo);

                et.commit();

            } catch (Exception ex) {
                ex.printStackTrace();
                et.rollback();
            } finally {
                em.close();
            }

            emf.close();
        }
        ```

    - ë¹„ì˜ì† ìƒíƒœì´ê¸° ë•Œë¬¸ì— `entitiesByKey=null` ì…ë‹ˆë‹¤.
    - ë¹„ì˜ì† ìƒíƒœëŠ” JPAê°€ ê´€ë¦¬í•˜ì§€ ëª»í•˜ê¸° ë•Œë¬¸ì— í•´ë‹¹ ê°ì²´ì˜ ë°ì´í„°ë¥¼ ë³€ê²½í•´ë„ ë³€ê²½ ê°ì§€ê°€ ì´ë£¨ì–´ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.
    - `em.persist(memo);` ë©”ì„œë“œ í˜¸ì¶œ í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì—ˆê³  MANAGED ìƒíƒœ ì¦‰, JPAê°€ ê´€ë¦¬í•˜ëŠ” ì˜ì† ìƒíƒœì˜ Entityê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.

- ì¤€ì˜ì†(**Detached**)
    - ì¤€ì˜ì† ìƒíƒœëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì–´ ê´€ë¦¬ë˜ë‹¤ê°€ ë¶„ë¦¬ëœ ìƒíƒœë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.
    - ì˜ì† ìƒíƒœì—ì„œ ì¤€ì˜ì† ìƒíƒœë¡œ ë°”ê¾¸ëŠ” ë°©ë²•
    - **detach(entity)**

        ```java
        em.detach(memo);
        ```

        - **detach(entity)** : íŠ¹ì • Entityë§Œ ì¤€ì˜ì† ìƒíƒœë¡œ ì „í™˜í•©ë‹ˆë‹¤.
            - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ê´€ë¦¬ë˜ë‹¤(**Managed**)ê°€ ****ë¶„ë¦¬ëœ ìƒíƒœ(**Detached**)ë¡œ ì „í™˜ë©ë‹ˆë‹¤.

        ```java
        @Test
        @DisplayName("ì¤€ì˜ì† ìƒíƒœ : detach()")
        void test2() {
            EntityTransaction et = em.getTransaction();

            et.begin();

            try {

                Memo memo = em.find(Memo.class, 1);
                System.out.println("memo.getId() = " + memo.getId());
                System.out.println("memo.getUsername() = " + memo.getUsername());
                System.out.println("memo.getContents() = " + memo.getContents());

                // em.contains(entity) : Entity ê°ì²´ê°€ í˜„ì¬ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì–´ ê´€ë¦¬ë˜ëŠ” ìƒíƒœì¸ì§€ í™•ì¸í•˜ëŠ” ë©”ì„œë“œ
                System.out.println("em.contains(memo) = " + em.contains(memo));

                System.out.println("detach() í˜¸ì¶œ");
                em.detach(memo);
                System.out.println("em.contains(memo) = " + em.contains(memo));

                System.out.println("memo Entity ê°ì²´ ìˆ˜ì • ì‹œë„");
                memo.setUsername("Update");
                memo.setContents("memo Entity Update");

                System.out.println("íŠ¸ëœì­ì…˜ commit ì „");
                et.commit();
                System.out.println("íŠ¸ëœì­ì…˜ commit í›„");

            } catch (Exception ex) {
                ex.printStackTrace();
                et.rollback();
            } finally {
                em.close();
            }

            emf.close();
        }
        ```

        - [ì½”ë“œ ìŠ¤ë‹ˆí«] detach(entity)

            ```java
            @Test
            @DisplayName("ì¤€ì˜ì† ìƒíƒœ : detach()")
            void test2() {
                EntityTransaction et = em.getTransaction();

                et.begin();

                try {

                    Memo memo = em.find(Memo.class, 1);
                    System.out.println("memo.getId() = " + memo.getId());
                    System.out.println("memo.getUsername() = " + memo.getUsername());
                    System.out.println("memo.getContents() = " + memo.getContents());

                    // em.contains(entity) : Entity ê°ì²´ê°€ í˜„ì¬ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì–´ ê´€ë¦¬ë˜ëŠ” ìƒíƒœì¸ì§€ í™•ì¸í•˜ëŠ” ë©”ì„œë“œ
                    System.out.println("em.contains(memo) = " + em.contains(memo));

                    System.out.println("detach() í˜¸ì¶œ");
                    em.detach(memo);
                    System.out.println("em.contains(memo) = " + em.contains(memo));

                    System.out.println("memo Entity ê°ì²´ ìˆ˜ì • ì‹œë„");
                    memo.setUsername("Update");
                    memo.setContents("memo Entity Update");

                    System.out.println("íŠ¸ëœì­ì…˜ commit ì „");
                    et.commit();
                    System.out.println("íŠ¸ëœì­ì…˜ commit í›„");

                } catch (Exception ex) {
                    ex.printStackTrace();
                    et.rollback();
                } finally {
                    em.close();
                }

                emf.close();
            }
            ```

        - `em.find(Memo.class, 1);` ë©”ì„œë“œ í˜¸ì¶œ í›„ MANAGED ìƒíƒœì…ë‹ˆë‹¤.
        - `em.detach(memo);` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ íŠ¹ì • Entity ê°ì²´ Memo#1ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì œê±°í•˜ì˜€ìŠµë‹ˆë‹¤.
        - ì¤€ì˜ì† ìƒíƒœë¡œ ì „í™˜ë˜ë©´ 1ì°¨ ìºì‹œ ì¦‰, ìºì‹œ ì €ì¥ì†Œì—ì„œ ì œê±°ë˜ê¸° ë•Œë¬¸ì— JPAì˜ ê´€ë¦¬ë¥¼ ë°›ì§€ ëª»í•´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ì–´ë– í•œ ê¸°ëŠ¥ë„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        - ë”°ë¼ì„œ memo Entity ê°ì²´ì˜ ë°ì´í„°ë¥¼ ìˆ˜ì •í•´ë„ ë³€ê²½ê°ì§€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ì–´ Update SQLì´ ìˆ˜í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
        - `em.contains(memo);` ëŠ” í•´ë‹¹ ê°ì²´ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì–´ ê´€ë¦¬ë˜ëŠ” ìƒíƒœì¸ì§€ í™•ì¸í•˜ëŠ” ë©”ì„œë“œë¡œ `em.detach(memo);` ì´í›„ í™•ì¸í–ˆì„ ë•Œ falseê°€ ì¶œë ¥ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    - **clear()**

        ```java
        em.clear();
        ```

        - **clear()** : ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì™„ì „íˆ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
            - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ëª¨ë“  Entityë¥¼ ì¤€ì˜ì† ìƒíƒœë¡œ ì „í™˜í•©ë‹ˆë‹¤.
            - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ í‹€ì€ ìœ ì§€í•˜ì§€ë§Œ ë‚´ìš©ì€ ë¹„ì›Œ ìƒˆë¡œ ë§Œë“  ê²ƒê³¼ ê°™ì€ ìƒíƒœê°€ ë©ë‹ˆë‹¤.
            - ë”°ë¼ì„œ ê³„ì†í•´ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

        ```java
        @Test
        @DisplayName("ì¤€ì˜ì† ìƒíƒœ : clear()")
        void test3() {
            EntityTransaction et = em.getTransaction();

            et.begin();

            try {

                Memo memo1 = em.find(Memo.class, 1);
                Memo memo2 = em.find(Memo.class, 2);

                // em.contains(entity) : Entity ê°ì²´ê°€ í˜„ì¬ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì–´ ê´€ë¦¬ë˜ëŠ” ìƒíƒœì¸ì§€ í™•ì¸í•˜ëŠ” ë©”ì„œë“œ
                System.out.println("em.contains(memo1) = " + em.contains(memo1));
                System.out.println("em.contains(memo2) = " + em.contains(memo2));

                System.out.println("clear() í˜¸ì¶œ");
                em.clear();
                System.out.println("em.contains(memo1) = " + em.contains(memo1));
                System.out.println("em.contains(memo2) = " + em.contains(memo2));

                System.out.println("memo#1 Entity ë‹¤ì‹œ ì¡°íšŒ");
                Memo memo = em.find(Memo.class, 1);
                System.out.println("em.contains(memo) = " + em.contains(memo));
                System.out.println("\n memo Entity ìˆ˜ì • ì‹œë„");
                memo.setUsername("Update");
                memo.setContents("memo Entity Update");

                System.out.println("íŠ¸ëœì­ì…˜ commit ì „");
                et.commit();
                System.out.println("íŠ¸ëœì­ì…˜ commit í›„");

            } catch (Exception ex) {
                ex.printStackTrace();
                et.rollback();
            } finally {
                em.close();
            }

            emf.close();
        }
        ```

        - [ì½”ë“œ ìŠ¤ë‹ˆí«] clear()

            ```java
            @Test
            @DisplayName("ì¤€ì˜ì† ìƒíƒœ : clear()")
            void test3() {
                EntityTransaction et = em.getTransaction();

                et.begin();

                try {

                    Memo memo1 = em.find(Memo.class, 1);
                    Memo memo2 = em.find(Memo.class, 2);

                    // em.contains(entity) : Entity ê°ì²´ê°€ í˜„ì¬ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì–´ ê´€ë¦¬ë˜ëŠ” ìƒíƒœì¸ì§€ í™•ì¸í•˜ëŠ” ë©”ì„œë“œ
                    System.out.println("em.contains(memo1) = " + em.contains(memo1));
                    System.out.println("em.contains(memo2) = " + em.contains(memo2));

                    System.out.println("clear() í˜¸ì¶œ");
                    em.clear();
                    System.out.println("em.contains(memo1) = " + em.contains(memo1));
                    System.out.println("em.contains(memo2) = " + em.contains(memo2));

                    System.out.println("memo#1 Entity ë‹¤ì‹œ ì¡°íšŒ");
                    Memo memo = em.find(Memo.class, 1);
                    System.out.println("em.contains(memo) = " + em.contains(memo));
                    System.out.println("\n memo Entity ìˆ˜ì • ì‹œë„");
                    memo.setUsername("Update");
                    memo.setContents("memo Entity Update");

                    System.out.println("íŠ¸ëœì­ì…˜ commit ì „");
                    et.commit();
                    System.out.println("íŠ¸ëœì­ì…˜ commit í›„");

                } catch (Exception ex) {
                    ex.printStackTrace();
                    et.rollback();
                } finally {
                    em.close();
                }

                emf.close();
            }
            ```
        - `em.clear();` ë©”ì„œë“œ í˜¸ì¶œ í›„ ì™„ì „íˆ ë¹„ì›Œì§„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - ë‹¤ì‹œ memo#1 Entityë¥¼ ì¡°íšŒí•˜ì—¬ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - `em.clear();` ë©”ì„œë“œ í˜¸ì¶œ í›„ `em.contains(memo1,2);` í™•ì¸í–ˆì„ ë•Œ falseê°€ ì¶œë ¥ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - ë‹¤ì‹œ memo#1 Entityë¥¼ ì¡°íšŒí•œ í›„ `em.contains(memo);` í™•ì¸í–ˆì„ ë•Œ trueê°€ ì¶œë ¥ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - ë˜í•œ memo Entity ê°ì²´ì˜ ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ì íŠ¸ëœì­ì…˜ commit í›„ Update SQLì´ ìˆ˜í–‰ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    - **close()**
        ```java
        em.close();
        ```
        - **close()** : ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
            - í•´ë‹¹ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ê´€ë¦¬í•˜ë˜ ì˜ì†ì„± ìƒíƒœì˜ Entityë“¤ì€ ëª¨ë‘ ì¤€ì˜ì† ìƒíƒœë¡œ ë³€ê²½ë©ë‹ˆë‹¤.
            - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆê¸° ë•Œë¬¸ì— ê³„ì†í•´ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

        ```java
        @Test
        @DisplayName("ì¤€ì˜ì† ìƒíƒœ : close()")
        void test4() {
            EntityTransaction et = em.getTransaction();

            et.begin();

            try {

                Memo memo1 = em.find(Memo.class, 1);
                Memo memo2 = em.find(Memo.class, 2);

                // em.contains(entity) : Entity ê°ì²´ê°€ í˜„ì¬ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì–´ ê´€ë¦¬ë˜ëŠ” ìƒíƒœì¸ì§€ í™•ì¸í•˜ëŠ” ë©”ì„œë“œ
                System.out.println("em.contains(memo1) = " + em.contains(memo1));
                System.out.println("em.contains(memo2) = " + em.contains(memo2));

                System.out.println("close() í˜¸ì¶œ");
                em.close();
                Memo memo = em.find(Memo.class, 2); // Session/EntityManager is closed ë©”ì‹œì§€ì™€ í•¨ê»˜ ì˜¤ë¥˜ ë°œìƒ
                System.out.println("memo.getId() = " + memo.getId());

            } catch (Exception ex) {
                ex.printStackTrace();
                et.rollback();
            } finally {
                em.close();
            }

            emf.close();
        }
        ```

        - [ì½”ë“œ ìŠ¤ë‹ˆí«] close()

            ```java
            @Test
            @DisplayName("ì¤€ì˜ì† ìƒíƒœ : close()")
            void test4() {
                EntityTransaction et = em.getTransaction();

                et.begin();

                try {

                    Memo memo1 = em.find(Memo.class, 1);
                    Memo memo2 = em.find(Memo.class, 2);

                    // em.contains(entity) : Entity ê°ì²´ê°€ í˜„ì¬ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì–´ ê´€ë¦¬ë˜ëŠ” ìƒíƒœì¸ì§€ í™•ì¸í•˜ëŠ” ë©”ì„œë“œ
                    System.out.println("em.contains(memo1) = " + em.contains(memo1));
                    System.out.println("em.contains(memo2) = " + em.contains(memo2));

                    System.out.println("close() í˜¸ì¶œ");
                    em.close();
                    Memo memo = em.find(Memo.class, 2); // Session/EntityManager is closed ë©”ì‹œì§€ì™€ í•¨ê»˜ ì˜¤ë¥˜ ë°œìƒ
                    System.out.println("memo.getId() = " + memo.getId());

                } catch (Exception ex) {
                    ex.printStackTrace();
                    et.rollback();
                } finally {
                    em.close();
                }

                emf.close();
            }
            ```
        - `em.close();` ë©”ì„œë“œ í˜¸ì¶œ ì´í›„ EntityManagerë¥¼ ì‚¬ìš©í•˜ë ¤ê³  í•˜ì ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì¢…ë£Œë˜ë©´ ê³„ì†í•´ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    - ì¤€ì˜ì† ìƒíƒœì—ì„œ ë‹¤ì‹œ ì˜ì† ìƒíƒœë¡œ ë°”ê¾¸ëŠ” ë°©ë²•
    - **merge(entity)**

        ```java
        em.merge(memo);
        ```

        - **merge(entity)** : ì „ë‹¬ë°›ì€ Entityë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ ì˜ì† ìƒíƒœì˜ Entityë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
        - **merge(entity)** ë™ì‘
            - íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ëœ Entityì˜ ì‹ë³„ì ê°’ìœ¼ë¡œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
                1. í•´ë‹¹ Entityê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—†ë‹¤ë©´?
                    1. DBì—ì„œ ìƒˆë¡­ê²Œ ì¡°íšŒí•©ë‹ˆë‹¤.
                    2. ì¡°íšŒí•œ Entityë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—  ì €ì¥í•©ë‹ˆë‹¤.
                    3. ì „ë‹¬ ë°›ì€ Entityì˜ ê°’ì„ ì‚¬ìš©í•˜ì—¬ ë³‘í•©í•©ë‹ˆë‹¤.
                    4. Update SQLì´ ìˆ˜í–‰ë©ë‹ˆë‹¤. (ìˆ˜ì •)
                2. ë§Œì•½ DBì—ì„œë„ ì—†ë‹¤ë©´ ?
                    1. ìƒˆë¡­ê²Œ ìƒì„±í•œ Entityë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥í•©ë‹ˆë‹¤.
                    2. Insert SQLì´ ìˆ˜í–‰ë©ë‹ˆë‹¤. (ì €ì¥)
        - ë”°ë¼ì„œ **merge(entity)** ë©”ì„œë“œëŠ” ë¹„ì˜ì†, ì¤€ì˜ì† ëª¨ë‘ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì„ ìˆ˜ ìˆìœ¼ë©° ìƒí™©ì— ë”°ë¼ â€˜ì €ì¥â€™ì„ í•  ìˆ˜ë„ â€˜ìˆ˜ì •â€™ì„ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

        1. **merge(entity)** ì €ì¥

        ```java
        @Test
        @DisplayName("merge() : ì €ì¥")
        void test5() {
            EntityTransaction et = em.getTransaction();

            et.begin();

            try {

                Memo memo = new Memo();
                memo.setId(3L);
                memo.setUsername("merge()");
                memo.setContents("merge() ì €ì¥");

                System.out.println("merge() í˜¸ì¶œ");
                Memo mergedMemo = em.merge(memo);

                System.out.println("em.contains(memo) = " + em.contains(memo));
                System.out.println("em.contains(mergedMemo) = " + em.contains(mergedMemo));

                System.out.println("íŠ¸ëœì­ì…˜ commit ì „");
                et.commit();
                System.out.println("íŠ¸ëœì­ì…˜ commit í›„");

            } catch (Exception ex) {
                ex.printStackTrace();
                et.rollback();
            } finally {
                em.close();
            }

            emf.close();
        }
        ```

        - [ì½”ë“œ ìŠ¤ë‹ˆí«] merge(entity) ì €ì¥

            ```java
            @Test
            @DisplayName("merge() : ì €ì¥")
            void test5() {
                EntityTransaction et = em.getTransaction();

                et.begin();

                try {

                    Memo memo = new Memo();
                    memo.setId(3L);
                    memo.setUsername("merge()");
                    memo.setContents("merge() ì €ì¥");

                    System.out.println("merge() í˜¸ì¶œ");
                    Memo mergedMemo = em.merge(memo);

                    System.out.println("em.contains(memo) = " + em.contains(memo));
                    System.out.println("em.contains(mergedMemo) = " + em.contains(mergedMemo));

                    System.out.println("íŠ¸ëœì­ì…˜ commit ì „");
                    et.commit();
                    System.out.println("íŠ¸ëœì­ì…˜ commit í›„");

                } catch (Exception ex) {
                    ex.printStackTrace();
                    et.rollback();
                } finally {
                    em.close();
                }

                emf.close();
            }
            ```

        - `em.merge(memo);` í˜¸ì¶œ í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— Memo#3 ê°ì²´ê°€ ì €ì¥ë˜ê³  Insert SQLì´ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - `em.merge(memo);` í˜¸ì¶œ í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— í•´ë‹¹ ê°’ì´ ì—†ì–´ DBì— ì¡°íšŒ í–ˆëŠ”ë°ë„ í•´ë‹¹ ê°’ì´ ì—†ê¸° ë•Œë¬¸ì— ìƒˆë¡­ê²Œ ìƒì„±í•˜ì—¬ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥í•˜ê³  Insert SQLì´ ìˆ˜í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.
            - ë¹„ì˜ì† ìƒíƒœì˜ memoëŠ” merge() í˜¸ì¶œ í›„ì— í•´ë‹¹ memo ê°ì²´ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ëœê²Œ ì•„ë‹ˆë¼ ìƒˆë¡­ê²Œ ìƒì„±ë˜ì–´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì—ˆê¸° ë•Œë¬¸ì— falseê°€ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.
            - ìƒˆë¡­ê²Œ ì €ì¥ëœ ì˜ì† ìƒíƒœì˜ ê°ì²´ë¥¼ ë°˜í™˜ë°›ì€ mergedMemoëŠ” trueê°€ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.

        1. **merge(entity)** ìˆ˜ì •

        ```java
        @Test
        @DisplayName("merge() : ìˆ˜ì •")
        void test6() {
            EntityTransaction et = em.getTransaction();

            et.begin();

            try {

                Memo memo = em.find(Memo.class, 3);
                System.out.println("memo.getId() = " + memo.getId());
                System.out.println("memo.getUsername() = " + memo.getUsername());
                System.out.println("memo.getContents() = " + memo.getContents());

                System.out.println("em.contains(memo) = " + em.contains(memo));

                System.out.println("detach() í˜¸ì¶œ");
                em.detach(memo); // ì¤€ì˜ì† ìƒíƒœë¡œ ì „í™˜
                System.out.println("em.contains(memo) = " + em.contains(memo));

                System.out.println("ì¤€ì˜ì† memo ê°’ ìˆ˜ì •");
                memo.setContents("merge() ìˆ˜ì •");

                System.out.println("\n merge() í˜¸ì¶œ");
                Memo mergedMemo = em.merge(memo);
                System.out.println("mergedMemo.getContents() = " + mergedMemo.getContents());

                System.out.println("em.contains(memo) = " + em.contains(memo));
                System.out.println("em.contains(mergedMemo) = " + em.contains(mergedMemo));

                System.out.println("íŠ¸ëœì­ì…˜ commit ì „");
                et.commit();
                System.out.println("íŠ¸ëœì­ì…˜ commit í›„");

            } catch (Exception ex) {
                ex.printStackTrace();
                et.rollback();
            } finally {
                em.close();
            }

            emf.close();
        }
        ```

        - [ì½”ë“œ ìŠ¤ë‹ˆí«] merge(entity) ìˆ˜ì •

            ```java
            @Test
            @DisplayName("merge() : ìˆ˜ì •")
            void test6() {
                EntityTransaction et = em.getTransaction();

                et.begin();

                try {

                    Memo memo = em.find(Memo.class, 3);
                    System.out.println("memo.getId() = " + memo.getId());
                    System.out.println("memo.getUsername() = " + memo.getUsername());
                    System.out.println("memo.getContents() = " + memo.getContents());

                    System.out.println("em.contains(memo) = " + em.contains(memo));

                    System.out.println("detach() í˜¸ì¶œ");
                    em.detach(memo); // ì¤€ì˜ì† ìƒíƒœë¡œ ì „í™˜
                    System.out.println("em.contains(memo) = " + em.contains(memo));

                    System.out.println("ì¤€ì˜ì† memo ê°’ ìˆ˜ì •");
                    memo.setContents("merge() ìˆ˜ì •");

                    System.out.println("\n merge() í˜¸ì¶œ");
                    Memo mergedMemo = em.merge(memo);
                    System.out.println("mergedMemo.getContents() = " + mergedMemo.getContents());

                    System.out.println("em.contains(memo) = " + em.contains(memo));
                    System.out.println("em.contains(mergedMemo) = " + em.contains(mergedMemo));

                    System.out.println("íŠ¸ëœì­ì…˜ commit ì „");
                    et.commit();
                    System.out.println("íŠ¸ëœì­ì…˜ commit í›„");

                } catch (Exception ex) {
                    ex.printStackTrace();
                    et.rollback();
                } finally {
                    em.close();
                }

                emf.close();
            }
            ```

        - detach() ë©”ì„œë“œ í˜¸ì¶œë¡œ ì¡°íšŒí•´ì˜¨ ì˜ì† ìƒíƒœì˜ memo ê°ì²´ë¥¼ ì¤€ì˜ì† ìƒíƒœë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤.
        - ì¤€ì˜ì† ìƒíƒœì˜ memoì˜ ê°’ì„ ìˆ˜ì •í•œ í›„ memo ê°ì²´ë¥¼ ì‚¬ìš©í•´ì„œ merge() ë©”ì„œë“œë¥¼ í˜¸ì¶œí–ˆìŠµë‹ˆë‹¤.
        - memo ê°ì²´ëŠ” ì¤€ì˜ì† ìƒíƒœì´ê¸° ë•Œë¬¸ì— í˜„ì¬ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ëŠ” í•´ë‹¹ ê°ì²´ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            - ë”°ë¼ì„œ DBì—ì„œ ì‹ë³„ì ê°’ì„ ì‚¬ìš©í•˜ì—¬ ì¡°íšŒí•œ í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥í•˜ê³  íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ì˜¨ ì¤€ì˜ì† ìƒíƒœì˜ memo ê°ì²´ì˜ ê°’ì„ ìƒˆë¡­ê²Œ ì €ì¥í•œ ì˜ì† ìƒíƒœì˜ ê°ì²´ì— ë³‘í•©í•˜ê³  ë°˜í™˜í•©ë‹ˆë‹¤.
            - ê·¸ ê²°ê³¼ ë°˜í™˜ëœ mergedMemoì˜ contentsë¥¼ ì¶œë ¥í•˜ì˜€ì„ ë•Œ ë³€ê²½ë˜ì—ˆë˜ ë‚´ìš©ì¸ â€œmerge() ìˆ˜ì •â€ì´ ì¶œë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.
            - íŠ¸ëœì­ì…˜ commit í›„ Update SQLì´ ìˆ˜í–‰ë©ë‹ˆë‹¤.
        - ì¤€ì˜ì† ìƒíƒœì˜ Entity memoëŠ” merge() í˜¸ì¶œ í›„ì—ë„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì–´ ìˆì§€ ì•Šê¸° ë•Œë¬¸ì— falseê°€ ë°˜í™˜ë˜ì—ˆê³ 
        - ìƒˆë¡­ê²Œ ì €ì¥ëœ ì˜ì† ìƒíƒœì˜ ê°ì²´ë¥¼ ë°˜í™˜ë°›ì€ mergedMemoëŠ” trueê°€ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.

- ì‚­ì œ(**Removed**)
    ```java
    em.remove(memo);
    ```
    - **remove(entity)** : ì‚­ì œí•˜ê¸° ìœ„í•´ ì¡°íšŒí•´ì˜¨ ì˜ì† ìƒíƒœì˜ Entityë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ë°›ì•„ ì‚­ì œ ìƒíƒœë¡œ ì „í™˜í•©ë‹ˆë‹¤.

# Spring Data JPA

## 11. SpringBootì˜ JPA

- SpringBoot í™˜ê²½ì—ì„œì˜ JPA
    - ë©”ëª¨ì¥ í”„ë¡œì íŠ¸ JPA ì„¤ì •
        - build.gradle
            - [ì½”ë“œ ìŠ¤ë‹ˆí«] build.gradle :  `spring-boot-starter-data-jpa` ì¶”ê°€

                ```groovy
                // JPA ì„¤ì •
                implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
                ```

        - application.properties : Hibernate ì„¤ì •
            - show_sql, format_sql, use_sql_comments ì˜µì…˜
                - Hibernateê°€ DBì— ìš”ì²­í•˜ëŠ” ëª¨ë“  SQLì„ ë³´ê¸°ì¢‹ê²Œ ì¶œë ¥ í•´ì¤ë‹ˆë‹¤.
            - ddl-auto
                - create : ê¸°ì¡´ í…Œì´ë¸” ì‚­ì œ í›„ ë‹¤ì‹œ ìƒì„±í•©ë‹ˆë‹¤. (DROP + CREATE)
                - create-drop : createì™€ ê°™ìœ¼ë‚˜ ì¢…ë£Œì‹œì ì— í…Œì´ë¸”ì„ DROP í•©ë‹ˆë‹¤.
                - update : ë³€ê²½ëœ ë¶€ë¶„ë§Œ ë°˜ì˜í•©ë‹ˆë‹¤.
                - validate : Entityì™€ í…Œì´ë¸”ì´ ì •ìƒ ë§¤í•‘ë˜ì—ˆëŠ”ì§€ë§Œ í™•ì¸í•©ë‹ˆë‹¤.
                - none: ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            - [ì½”ë“œ ìŠ¤ë‹ˆí«] application.properties : Hibernate ì„¤ì •

                ```groovy
                spring.jpa.hibernate.ddl-auto=update

                spring.jpa.properties.hibernate.show_sql=true
                spring.jpa.properties.hibernate.format_sql=true
                spring.jpa.properties.hibernate.use_sql_comments=true
                ```

        - Memo Entity
            - [ì½”ë“œ ìŠ¤ë‹ˆí«] Memo Entity

                ```java
                package com.sparta.memo.entity;

                import com.sparta.memo.dto.MemoRequestDto;
                import jakarta.persistence.*;
                import lombok.Getter;
                import lombok.NoArgsConstructor;
                import lombok.Setter;

                @Entity // JPAê°€ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” Entity í´ë˜ìŠ¤ ì§€ì •
                @Getter
                @Setter
                @Table(name = "memo") // ë§¤í•‘í•  í…Œì´ë¸”ì˜ ì´ë¦„ì„ ì§€ì •
                @NoArgsConstructor
                public class Memo {
                    @Id
                    @GeneratedValue(strategy = GenerationType.IDENTITY)
                    private Long id;
                    @Column(name = "username", nullable = false)
                    private String username;
                    @Column(name = "contents", nullable = false, length = 500)
                    private String contents;

                    public Memo(MemoRequestDto requestDto) {
                        this.username = requestDto.getUsername();
                        this.contents = requestDto.getContents();
                    }

                    public void update(MemoRequestDto requestDto) {
                        this.username = requestDto.getUsername();
                        this.contents = requestDto.getContents();
                    }
                }
                ```

    - SpringBoot í™˜ê²½ì—ì„œëŠ” EntityManagerFactoryì™€ EntityManagerë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•´ì¤ë‹ˆë‹¤.
        - application.propertiesì— DB ì •ë³´ë¥¼ ì „ë‹¬í•´ ì£¼ë©´ ì´ë¥¼ í† ëŒ€ë¡œ EntityManagerFactoryê°€ ìƒì„±ë©ë‹ˆë‹¤.

    ```java
    @PersistenceContext
    EntityManager em;
    ```

    - @PersistenceConext ì• ë„ˆí…Œì´ì…˜ì„ ì‚¬ìš©í•˜ë©´ ìë™ìœ¼ë¡œ ìƒì„±ëœ EntityManagerë¥¼ ì£¼ì…ë°›ì•„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- Springì˜ íŠ¸ëœì­ì…˜
    - Spring í”„ë ˆì„ì›Œí¬ì—ì„œëŠ” DBì˜ íŠ¸ëœì­ì…˜ ê°œë…ì„ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì ìš©í•  ìˆ˜ ìˆë„ë¡ íŠ¸ëœì­ì…˜ ê´€ë¦¬ìë¥¼ ì œê³µí•©ë‹ˆë‹¤.

    ```java
    @Transactional(readOnly = true)
    public class SimpleJpaRepository<T, ID> implements JpaRepositoryImplementation<T, ID> {
    						...

    		@Transactional
    		@Override
    		public <S extends T> S save(S entity) {

    			Assert.notNull(entity, "Entity must not be null");

    			if (entityInformation.isNew(entity)) {
    				em.persist(entity);
    				return entity;
    			} else {
    				return em.merge(entity);
    			}
    		}

    						...
    }
    ```

    - ì˜ˆì‹œ ì½”ë“œ ì²˜ëŸ¼ @Transactional ì• ë„ˆí…Œì´ì…˜ì„ í´ë˜ìŠ¤ë‚˜ ë©”ì„œë“œì— ì¶”ê°€í•˜ë©´ ì‰½ê²Œ íŠ¸ëœì­ì…˜ ê°œë…ì„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - ë©”ì„œë“œê°€ í˜¸ì¶œë˜ë©´, í•´ë‹¹ ë©”ì„œë“œ ë‚´ì—ì„œ ìˆ˜í–‰ë˜ëŠ” ëª¨ë“  DB ì—°ì‚° ë‚´ìš©ì€ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì…ë‹ˆë‹¤.
        - ì´ë•Œ, í•´ë‹¹ ë©”ì„œë“œê°€ ì •ìƒì ìœ¼ë¡œ ìˆ˜í–‰ë˜ë©´ íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•˜ê³ , ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ë¡¤ë°±í•©ë‹ˆë‹¤.
        - í´ë˜ìŠ¤ì— ì„ ì–¸í•œ @Transactionalì€ í•´ë‹¹ í´ë˜ìŠ¤ ë‚´ë¶€ì˜ ëª¨ë“  ë©”ì„œë“œì— íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
        - ì´ë•Œ,  save ë©”ì„œë“œëŠ” @Transactional ì• ë„ˆí…Œì´ì…˜ì´ ì¶”ê°€ë˜ì–´ìˆê¸° ë•Œë¬¸ì— `readOnly = true` ì˜µì…˜ì¸ @Transactionalì„ ë®ì–´ì“°ê²Œ ë˜ì–´ `readOnly = false` ì˜µì…˜ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.
            - `readOnly = true` ì˜µì…˜
                - íŠ¸ëœì­ì…˜ì—ì„œ ë°ì´í„°ë¥¼ ì½ê¸°ë§Œ í•  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
                - ì´ ì†ì„±ì„ ì‚¬ìš©í•˜ë©´ ì½ê¸° ì‘ì—…ì— ëŒ€í•œ ìµœì í™”ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                - ë§Œì•½, í•´ë‹¹ íŠ¸ëœì­ì…˜ì—ì„œ ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ë ¤ê³  í•˜ë©´ ì˜ˆì™¸ê°€ ë°œìƒí•˜ê¸° ë•Œë¬¸ì— ì£¼ì˜í•´ì•¼í•©ë‹ˆë‹¤.

- @Transactional
    - íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸

        ```java
        @Test
        @Transactional
        @Rollback(value = false) // í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œ @Transactional ë¥¼ ì‚¬ìš©í•˜ë©´ í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œëœ í›„ ë¡¤ë°±í•˜ê¸° ë•Œë¬¸ì— false ì˜µì…˜ ì¶”ê°€
        @DisplayName("ë©”ëª¨ ìƒì„± ì„±ê³µ")
        void test1() {
            Memo memo = new Memo();
            memo.setUsername("Robbert");
            memo.setContents("@Transactional í…ŒìŠ¤íŠ¸ ì¤‘!");
            em.persist(memo);  // ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë©”ëª¨ Entity ê°ì²´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
        }
        ```

        - [ì½”ë“œ ìŠ¤ë‹ˆí«] íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸ : ë©”ëª¨ ìƒì„± ì„±ê³µ

            ```java
            @Test
            @Transactional
            @Rollback(value = false) // í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œ @Transactional ë¥¼ ì‚¬ìš©í•˜ë©´ í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œëœ í›„ ë¡¤ë°±í•˜ê¸° ë•Œë¬¸ì— false ì˜µì…˜ ì¶”ê°€
            @DisplayName("ë©”ëª¨ ìƒì„± ì„±ê³µ")
            void test1() {
                Memo memo = new Memo();
                memo.setUsername("Robbert");
                memo.setContents("@Transactional í…ŒìŠ¤íŠ¸ ì¤‘!");

                em.persist(memo);  // ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë©”ëª¨ Entity ê°ì²´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
            }
            ```

        - íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ì–´ DB ì‘ì—…ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤.

    ```java
    @Test
    @DisplayName("ë©”ëª¨ ìƒì„± ì‹¤íŒ¨")
    void test2() {
        Memo memo = new Memo();
        memo.setUsername("Robbie");
        memo.setContents("@Transactional í…ŒìŠ¤íŠ¸ ì¤‘!");

        em.persist(memo);  // ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë©”ëª¨ Entity ê°ì²´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
    }
    ```

    - [ì½”ë“œ ìŠ¤ë‹ˆí«] íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸ : ë©”ëª¨ ìƒì„± ì‹¤íŒ¨

        ```java
        @Test
        @DisplayName("ë©”ëª¨ ìƒì„± ì‹¤íŒ¨")
        void test2() {
            Memo memo = new Memo();
            memo.setUsername("Robbie");
            memo.setContents("@Transactional í…ŒìŠ¤íŠ¸ ì¤‘!");

            em.persist(memo);  // ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë©”ëª¨ Entity ê°ì²´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
        }
        ```

    - íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ì§€ ëª»í•´ ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.
    - ì¦‰, JPAë¥¼ ì‚¬ìš©í•˜ì—¬ DBì— ë°ì´í„°ë¥¼ ì €ì¥, ìˆ˜ì •, ì‚­ì œ í•˜ë ¤ë©´ íŠ¸ëœì­ì…˜ ì ìš©ì´ ë°˜ë“œì‹œ í•„ìš”í•©ë‹ˆë‹¤.
        - ì¡°íšŒ ì‘ì—…ì€ ë‹¨ìˆœí•˜ê²Œ ë°ì´í„°ë¥¼ ì½ê¸°ë§Œ í•˜ê¸° ë•Œë¬¸ì— íŠ¸ëœì­ì…˜ ì ìš©ì´ í•„ìˆ˜ëŠ” ì•„ë‹™ë‹ˆë‹¤.
            - ë‹¤ë§Œ ì¡°íšŒì˜ ê²½ìš°ì—ë„ íŠ¸ëœì­ì…˜ í™˜ê²½ì´ í•„ìš”í•œ ê²½ìš°ê°€ ìˆì„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì—
            - ì¡°íšŒ ì‘ì—… ê¸°ëŠ¥ë§Œ ì¡´ì¬í•˜ëŠ” ë©”ì„œë“œì¼ ê²½ìš°ì—ë§Œ ì•ì„œ ë³¸ ì˜ˆì‹œì²˜ëŸ¼ `readOnly = true` ì˜µì…˜ì´ ì„¤ì •ëœ @Transactionalì„ ì ìš©í•˜ë©´ ì¢‹ìŠµë‹ˆë‹¤.

- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ íŠ¸ëœì­ì…˜ì˜ ìƒëª…ì£¼ê¸°
    - ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆ í™˜ê²½ì—ì„œëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ íŠ¸ëœì­ì…˜ì˜ ìƒëª…ì£¼ê¸°ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.
    - ì‰½ê²Œ ì„¤ëª…í•˜ìë©´ íŠ¸ëœì­ì…˜ì´ ìœ ì§€ë˜ëŠ” ë™ì•ˆì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë„ ê³„ì† ìœ ì§€ê°€ ë˜ê¸° ë•Œë¬¸ì— ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - ë”°ë¼ì„œ ì•ì—ì„œ ì‘ì„±í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œ ë©”ì„œë“œì— íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ìœ ì§€ë˜ì§€ ëª»í•´ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì—ˆìŠµë‹ˆë‹¤.
    âš ï¸ Springì€ ì–´ë–»ê²Œ Service ë¶€í„° Repository ê¹Œì§€ Transactionì„ ìœ ì§€í•  ìˆ˜ ìˆëŠ” ê±¸ê¹Œìš”?
    - Serviceì˜ íŠ¸ëœì­ì…˜ì´ ì ìš©ëœ ë©”ì„œë“œì—ì„œ Repositoryì˜ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•  ë•Œ ë¬´ì–¸ê°€ ì²˜ë¦¬ë˜ê³  ìˆëŠ” ê²ƒì´ ìˆëŠ” ê±¸ê¹Œìš”?
    - Springì—ì„œëŠ” ì´ëŸ¬í•œ ìƒí™©ì—ì„œ íŠ¸ëœì­ì…˜ì„ ì œì–´í•  ìˆ˜ ìˆë„ë¡ íŠ¸ëœì­ì…˜ ì „íŒŒ ê¸°ëŠ¥ì„ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤.

- íŠ¸ëœì­ì…˜ ì „íŒŒ
    - @Transactionalì—ì„œ íŠ¸ëœì­ì…˜ ì „íŒŒ ì˜µì…˜ì„ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - íŠ¸ëœì­ì…˜ ì „íŒŒì˜ ê¸°ë³¸ ì˜µì…˜ì€ ***REQUIRED*** ì…ë‹ˆë‹¤.
    - ***REQUIRED*** ì˜µì…˜ì€ ****ë¶€ëª¨ ë©”ì„œë“œì— íŠ¸ëœì­ì…˜ì´ ì¡´ì¬í•˜ë©´ ìì‹ ë©”ì„œë“œì˜ íŠ¸ëœì­ì…˜ì€ **ë¶€ëª¨ì˜ íŠ¸ëœì­ì…˜ì— í•©ë¥˜**í•˜ê²Œë©ë‹ˆë‹¤.
    - íŠ¸ëœì­ì…˜ ì „íŒŒ í…ŒìŠ¤íŠ¸
        - [ì½”ë“œ ìŠ¤ë‹ˆí«] íŠ¸ëœì­ì…˜ ì „íŒŒ : MemoRepository

            ```java
            @Transactional
            public Memo createMemo(EntityManager em) {
                Memo memo = em.find(Memo.class, 1);
                memo.setUsername("Robbie");
                memo.setContents("@Transactional ì „íŒŒ í…ŒìŠ¤íŠ¸ ì¤‘!");

                System.out.println("createMemo ë©”ì„œë“œ ì¢…ë£Œ");
                return memo;
            }
            ```

        - [ì½”ë“œ ìŠ¤ë‹ˆí«] íŠ¸ëœì­ì…˜ ì „íŒŒ : test3

            ```java
            package com.sparta.memo;

            import com.sparta.memo.entity.Memo;
            import com.sparta.memo.repository.MemoRepository;
            import jakarta.persistence.EntityManager;
            import jakarta.persistence.PersistenceContext;
            import org.junit.jupiter.api.Disabled;
            import org.junit.jupiter.api.DisplayName;
            import org.junit.jupiter.api.Test;
            import org.springframework.beans.factory.annotation.Autowired;
            import org.springframework.boot.test.context.SpringBootTest;
            import org.springframework.test.annotation.Rollback;
            import org.springframework.transaction.annotation.Transactional;

            @SpringBootTest
            public class TransactionTest {

                @PersistenceContext
                EntityManager em;

                @Autowired
                MemoRepository memoRepository;

                @Test
                @Transactional
                @Rollback(value = false) // í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œ @Transactional ë¥¼ ì‚¬ìš©í•˜ë©´ í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œëœ í›„ ë¡¤ë°±í•˜ê¸° ë•Œë¬¸ì— false ì˜µì…˜ ì¶”ê°€
                @DisplayName("ë©”ëª¨ ìƒì„± ì„±ê³µ")
                void test1() {
                    Memo memo = new Memo();
                    memo.setUsername("Robbert");
                    memo.setContents("@Transactional í…ŒìŠ¤íŠ¸ ì¤‘!");

                    em.persist(memo);  // ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë©”ëª¨ Entity ê°ì²´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
                }

                @Test
                @Disabled
                @DisplayName("ë©”ëª¨ ìƒì„± ì‹¤íŒ¨")
                void test2() {
                    Memo memo = new Memo();
                    memo.setUsername("Robbie");
                    memo.setContents("@Transactional í…ŒìŠ¤íŠ¸ ì¤‘!");

                    em.persist(memo);  // ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë©”ëª¨ Entity ê°ì²´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
                }

                @Test
                @Transactional
                @Rollback(value = false)
                @DisplayName("íŠ¸ëœì­ì…˜ ì „íŒŒ í…ŒìŠ¤íŠ¸")
                void test3() {
                    memoRepository.createMemo(em);
                    System.out.println("í…ŒìŠ¤íŠ¸ test3 ë©”ì„œë“œ ì¢…ë£Œ");
                }
            }
            ```
        - ì‹¤í–‰ ê²°ê³¼ ìì‹ ë©”ì„œë“œ createMemoê°€ ì¢…ë£Œë  ë•Œ updateê°€ ì‹¤í–‰ë˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ë¶€ëª¨ ë©”ì„œë“œì— íŠ¸ëœì­ì…˜ì´ í•©ë¥˜ë˜ë©´ì„œ ë¶€ëª¨ ë©”ì„œë“œê°€ ì¢…ë£Œëœ í›„ íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë  ë•Œ updateê°€ ì‹¤í–‰ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - ë¶€ëª¨ ë©”ì„œë“œ test3ì˜ @Transactional @Rollback(value = false)ì„ ì£¼ì„ ì²˜ë¦¬í•˜ê³  ë‹¤ì‹œ í•œë²ˆ updateë¥¼ ì‹œë„í•´ë³´ë©´ í•©ë¥˜í•  ë¶€ëª¨ íŠ¸ëœì­ì…˜ì´ ì—†ê¸° ë•Œë¬¸ì—
            - ì´ì²˜ëŸ¼ ìì‹ ë©”ì„œë“œê°€ ì¢…ë£Œëœ í›„ íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ë©´ì„œ updateê°€ ì‹¤í–‰ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## 12. Spring Data JPAë€ ë¬´ì—‡ì¼ê¹Œ?

- Spring Data JPAë€?
    - **Spring Data JPA**ëŠ” **JPA**ë¥¼ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë§Œë“¤ì–´ë†“ì€ í•˜ë‚˜ì˜ ëª¨ë“ˆì…ë‹ˆë‹¤.
        - **JPA**ë¥¼ ì¶”ìƒí™”ì‹œí‚¨ **Repository** ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
    - **Repository ì¸í„°í˜ì´ìŠ¤**ëŠ” **Hibernate**ì™€ ê°™ì€ **JPAêµ¬í˜„ì²´**ë¥¼ ì‚¬ìš©í•´ì„œ ****êµ¬í˜„í•œ í´ë˜ìŠ¤ë¥¼ í†µí•´ ì‚¬ìš©ë©ë‹ˆë‹¤.
        - ê°œë°œìë“¤ì€ **Repository** ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ JPAë¥¼ ê°„í¸í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

- Spring Data JPAì˜ SimpleJpaRepository
    - Spring Data JPAì—ì„œëŠ” JpaRepository ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” í´ë˜ìŠ¤ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•´ì¤ë‹ˆë‹¤.
        - Spring ì„œë²„ê°€ ëœ° ë•Œ JpaRepository ì¸í„°í˜ì´ìŠ¤ë¥¼ ìƒì†ë°›ì€ ì¸í„°í˜ì´ìŠ¤ê°€ ìë™ìœ¼ë¡œ ìŠ¤ìº”ì´ ë˜ë©´,
        - í•´ë‹¹ ì¸í„°í˜ì´ìŠ¤ì˜ ì •ë³´ë¥¼ í† ëŒ€ë¡œ ìë™ìœ¼ë¡œ **SimpleJpaRepository** í´ë˜ìŠ¤ë¥¼ ìƒì„±í•´ ì£¼ê³ , ì´ í´ë˜ìŠ¤ë¥¼ Spring â€˜**Bean**â€™ìœ¼ë¡œ ë“±ë¡í•©ë‹ˆë‹¤.
    - ë”°ë¼ì„œ ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ì§ì ‘ ì‘ì„±í•˜ì§€ ì•Šì•„ë„ JpaRepository ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ JPAì˜ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- Spring Data JPA ì‚¬ìš©ë°©ë²•
    - JpaRepository ë“±ë¡
        - **JpaRepository**<**"@Entity í´ë˜ìŠ¤", "@Id ì˜ ë°ì´í„° íƒ€ì…">**ë¥¼ ìƒì†ë°›ëŠ” interface ë¡œ ì„ ì–¸í•©ë‹ˆë‹¤.
            - Spring Data JPAì— ì˜í•´ ìë™ìœ¼ë¡œ Bean ë“±ë¡ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.
            - ì œë„¤ë¦­ìŠ¤ì˜ **@Entity í´ë˜ìŠ¤** ìœ„ì¹˜ì— Memo Entityë¥¼ ì¶”ê°€í–ˆê¸° ë•Œë¬¸ì— í•´ë‹¹ MemoRepositoryëŠ” DBì˜ memo í…Œì´ë¸”ê³¼ ì—°ê²°ë˜ì–´ CRUD ì‘ì—…ì„ ì²˜ë¦¬í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.

- ë©”ëª¨ì¥ í”„ë¡œì íŠ¸ Spring Data JPA ì ìš©
    - MemoRepository

        ```java
        public interface MemoRepository extends JpaRepository<Memo, Long> {

        }
        ```

    - save

        ```java
        public MemoResponseDto createMemo(MemoRequestDto requestDto) {
            // RequestDto -> Entity
            Memo memo = new Memo(requestDto);

            // DB ì €ì¥
            Memo saveMemo = memoRepository.save(memo);

            // Entity -> ResponseDto
            MemoResponseDto memoResponseDto = new MemoResponseDto(saveMemo);

            return memoResponseDto;
        }
        ```
        - SimpleJpaRepositoryì˜ save ë©”ì„œë“œë¥¼ í™•ì¸í•´ë³´ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— entityë¥¼ ì €ì¥í•˜ëŠ” ì½”ë“œê°€ ì‘ì„±ë˜ì–´ìˆìŠµë‹ˆë‹¤.
        - save ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ ë°ì´í„°ë¥¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            - íŒŒë¼ë¯¸í„°ë¡œëŠ” ì €ì¥í•˜ë ¤ëŠ” entity ê°ì²´ë¥¼ ë„£ì–´ì£¼ë©´ ë©ë‹ˆë‹¤.
            - í•´ë‹¹ ë©”ì„œë“œì— @Transactionalì´ ì ìš©ë˜ì–´ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    - findAll

        ```java
        public List<MemoResponseDto> getMemos() {
            // DB ì¡°íšŒ
            return memoRepository.findAll().stream().map(MemoResponseDto::new).toList();
        }
        ```
        - findAll ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ í•´ë‹¹ í…Œì´ë¸”ì˜ ì „ì²´ ë°ì´í„°ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    - findById

        ```java
        private Memo findMemo(Long id) {
            return memoRepository.findById(id).orElseThrow(() ->
                    new IllegalArgumentException("ì„ íƒí•œ ë©”ëª¨ëŠ” ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            );
        }
        ```
        - SimpleJpaRepositoryì˜ findById ë©”ì„œë“œë¥¼ í™•ì¸í•´ë³´ë©´ ë°˜í™˜ íƒ€ì…ì´ Optionalì¸ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            - íŒŒë¼ë¯¸í„°ë¡œëŠ” ì‚­ì œí•˜ê³ ìí•˜ëŠ” Entityì˜ id ê°’ì„ ë„£ì–´ì£¼ë©´ ë©ë‹ˆë‹¤.
        - Optional<Entity íƒ€ì…>ì„ ë°˜í™˜ íƒ€ì…ìœ¼ë¡œ ë°›ê³  ì¶”ê°€ì ìœ¼ë¡œ nullì„ ì²´í¬í•˜ê±°ë‚˜
        - ìœ„ ì½”ë“œì™€ ê°™ì´ orElseThrowë¥¼ ì‚¬ìš©í•˜ì—¬ ë°˜í™˜ ê°’ì´ nullì¼ ê²½ìš° ì˜ˆì™¸ë¥¼ ë˜ì§€ë„ë¡ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - ì•ìœ¼ë¡œì˜ ê°•ì˜ì—ì„œëŠ” ìµœëŒ€í•œ ì½”ë“œ ìˆ˜ë¥¼ ì ê²Œ í•˜ê¸°ìœ„í•´ orElseThrowë¥¼ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤.
        - Optional ìë£Œ
            - [ì½”ë“œ ìŠ¤ë‹ˆí«] Optional

                ```java
                https://www.baeldung.com/java-optional
                ```

                [Guide To Java 8 Optional | Baeldung](https://www.baeldung.com/java-optional)

    - update
        ```java
        @Transactional
        public Long updateMemo(Long id, MemoRequestDto requestDto) {
            // í•´ë‹¹ ë©”ëª¨ê°€ DBì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            Memo memo = findMemo(id);

            // memo ë‚´ìš© ìˆ˜ì •
            memo.update(requestDto);

            return id;
        }
        ```

        - SimpleJpaRepositoryì— updateë¼ëŠ” ë©”ì„œë“œëŠ” ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        - ë”°ë¼ì„œ ìœ„ ì½”ë“œì²˜ëŸ¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ë³€ê²½ê°ì§€ë¥¼ í†µí•´ updateë¥¼ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.
        - ë³€ê²½ê°ì§€ê°€ ì ìš©ë˜ê¸° ìœ„í•´ í•´ë‹¹ ë©”ì„œë“œì— @Transactionalì„ ì¶”ê°€í•˜ì˜€ìŠµë‹ˆë‹¤.

    - delete

        ```java
        public Long deleteMemo(Long id) {
            // í•´ë‹¹ ë©”ëª¨ê°€ DBì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            Memo memo = findMemo(id);

            // memo ì‚­ì œ
            memoRepository.delete(memo);

            return id;
        }
        ```
        - delete ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ í•´ë‹¹ Entity(ë°ì´í„°)ë¥¼ í…Œì´ë¸”ì—ì„œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - íŒŒë¼ë¯¸í„°ë¡œëŠ” ì‚­ì œí•˜ë ¤ëŠ” entity ê°ì²´ë¥¼ ë„£ì–´ì£¼ë©´ ë©ë‹ˆë‹¤.
        - delete ë©”ì„œë“œì— @Transactionalì´ ì ìš©ë˜ì–´ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    - MemoService
        - [ì½”ë“œ ìŠ¤ë‹ˆí«] MemoService

            ```java
            package com.sparta.memo.service;

            import com.sparta.memo.dto.MemoRequestDto;
            import com.sparta.memo.dto.MemoResponseDto;
            import com.sparta.memo.entity.Memo;
            import com.sparta.memo.repository.MemoRepository;
            import org.springframework.stereotype.Service;
            import org.springframework.transaction.annotation.Transactional;

            import java.util.List;

            @Service
            public class MemoService {

                private final MemoRepository memoRepository;

                public MemoService(MemoRepository memoRepository) {
                    this.memoRepository = memoRepository;
                }

                public MemoResponseDto createMemo(MemoRequestDto requestDto) {
                    // RequestDto -> Entity
                    Memo memo = new Memo(requestDto);

                    // DB ì €ì¥
                    Memo saveMemo = memoRepository.save(memo);

                    // Entity -> ResponseDto
                    MemoResponseDto memoResponseDto = new MemoResponseDto(saveMemo);

                    return memoResponseDto;
                }

                public List<MemoResponseDto> getMemos() {
                    // DB ì¡°íšŒ
                    return memoRepository.findAll().stream().map(MemoResponseDto::new).toList();
                }

                @Transactional
                public Long updateMemo(Long id, MemoRequestDto requestDto) {
                    // í•´ë‹¹ ë©”ëª¨ê°€ DBì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                    Memo memo = findMemo(id);

                    // memo ë‚´ìš© ìˆ˜ì •
                    memo.update(requestDto);

                    return id;
                }

                public Long deleteMemo(Long id) {
                    // í•´ë‹¹ ë©”ëª¨ê°€ DBì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                    Memo memo = findMemo(id);

                    // memo ì‚­ì œ
                    memoRepository.delete(memo);

                    return id;
                }

                private Memo findMemo(Long id) {
                    return memoRepository.findById(id).orElseThrow(() ->
                            new IllegalArgumentException("ì„ íƒí•œ ë©”ëª¨ëŠ” ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
                    );
                }
            }
            ```

## 13. JPA Auditing ì ìš©í•˜ê¸°

- Timestamped
    ğŸ“Œ ë°ì´í„°ì˜ ìƒì„±(created_at), ìˆ˜ì •(modified_at) ì‹œê°„ì€
    í¬ìŠ¤íŒ…, ê²Œì‹œê¸€, ëŒ“ê¸€ ë“± ë‹¤ì–‘í•œ ë°ì´í„°ì— ë§¤ìš° ìì£¼ í™œìš©ë©ë‹ˆë‹¤.
    ê°ê°ì˜ Entityì˜ ìƒì„± ìˆ˜ì • ì‹œê°„ì„ ë§¤ë²ˆ ì‘ì„±í•˜ëŠ”ê±´ ë„ˆë¬´ ë¹„íš¨ìœ¨ì ì…ë‹ˆë‹¤.

    ```java
    @Getter
    @MappedSuperclass
    @EntityListeners(AuditingEntityListener.class)
    public abstract class Timestamped {

        @CreatedDate
        @Column(updatable = false)
        @Temporal(TemporalType.TIMESTAMP)
        private LocalDateTime createdAt;

        @LastModifiedDate
        @Column
        @Temporal(TemporalType.TIMESTAMP)
        private LocalDateTime modifiedAt;
    }
    ```

    - **Spring Data JPA**ì—ì„œëŠ” ì‹œê°„ì— ëŒ€í•´ì„œ ìë™ìœ¼ë¡œ ê°’ì„ ë„£ì–´ì£¼ëŠ” ê¸°ëŠ¥ì¸ JPA Auditingì„ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤.
    - **@MappedSuperclass**
        - JPA Entity í´ë˜ìŠ¤ë“¤ì´ í•´ë‹¹ ì¶”ìƒ í´ë˜ìŠ¤ë¥¼ ìƒì†í•  ê²½ìš° createdAt, modifiedAt ì²˜ëŸ¼ ì¶”ìƒ í´ë˜ìŠ¤ì— ì„ ì–¸í•œ ë©¤ë²„ë³€ìˆ˜ë¥¼ ì»¬ëŸ¼ìœ¼ë¡œ ì¸ì‹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - **@EntityListeners(AuditingEntityListener.class)**
        - í•´ë‹¹ í´ë˜ìŠ¤ì— Auditing ê¸°ëŠ¥ì„ í¬í•¨ì‹œì¼œ ì¤ë‹ˆë‹¤.
    - **@CreatedDate**
        - Entity ê°ì²´ê°€ ìƒì„±ë˜ì–´ ì €ì¥ë  ë•Œ ì‹œê°„ì´ ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.
        - ìµœì´ˆ ìƒì„± ì‹œê°„ì´ ì €ì¥ë˜ê³  ê·¸ ì´í›„ì—ëŠ” ìˆ˜ì •ë˜ë©´ ì•ˆë˜ê¸° ë•Œë¬¸ì— `updatable = false` ì˜µì…˜ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
    - **@LastModifiedDate**
        - ì¡°íšŒí•œ Entity ê°ì²´ì˜ ê°’ì„ ë³€ê²½í•  ë•Œ ë³€ê²½ëœ ì‹œê°„ì´ ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.
        - ì²˜ìŒ ìƒì„± ì‹œê°„ì´ ì €ì¥ëœ ì´í›„ ë³€ê²½ì´ ì¼ì–´ë‚  ë•Œë§ˆë‹¤ í•´ë‹¹ ë³€ê²½ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
    - **@Temporal**
        - ë‚ ì§œ íƒ€ì…(java.util.Date, java.util.Calendar)ì„ ë§¤í•‘í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        - DBì—ëŠ” Date(ë‚ ì§œ), Time(ì‹œê°„), Timestamp(ë‚ ì§œì™€ ì‹œê°„)ë¼ëŠ” ì„¸ ê°€ì§€ íƒ€ì…ì´ ë³„ë„ë¡œ ì¡´ì¬í•©ë‹ˆë‹¤.
            - **DATE : ex) 2023-01-01**
            - **TIME : ex) 20:21:14**
            - **TIMESTAMP : ex) 2023-01-01 20:22:38.771000**

    âš ï¸ `@SpringBootApplication` ì´ ìˆëŠ” classì— `@EnableJpaAuditing` ì¶”ê°€!
    - JPA Auditing ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ê² ë‹¤ëŠ” ì •ë³´ë¥¼ ì „ë‹¬í•´ì£¼ê¸° ìœ„í•´ `@EnableJpaAuditing` ì„ ì¶”ê°€í•´ì•¼í•©ë‹ˆë‹¤.

- ë©”ëª¨ì¥ í”„ë¡œì íŠ¸ì— JPA Auditing ì ìš©
    1. Timestamped ìƒì„±
        - [ì½”ë“œ ìŠ¤ë‹ˆí«] entity > Timestamped

            ```java
            package com.sparta.memo.entity;

            import jakarta.persistence.*;
            import lombok.Getter;
            import org.springframework.data.annotation.CreatedDate;
            import org.springframework.data.annotation.LastModifiedDate;
            import org.springframework.data.jpa.domain.support.AuditingEntityListener;

            import java.time.LocalDateTime;

            @Getter
            @MappedSuperclass
            @EntityListeners(AuditingEntityListener.class)
            public abstract class Timestamped {

                @CreatedDate
                @Column(updatable = false)
                @Temporal(TemporalType.TIMESTAMP)
                private LocalDateTime createdAt;

                @LastModifiedDate
                @Column
                @Temporal(TemporalType.TIMESTAMP)
                private LocalDateTime modifiedAt;
            }
            ```

    2. @EnableJpaAuditing ì• ë„ˆí…Œì´ì…˜ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
    3. ì ìš©í•˜ê³ ìí•˜ëŠ” Entity í´ë˜ìŠ¤ì—ì„œ Timestampedë¥¼ ìƒì†ë°›ìŠµë‹ˆë‹¤.

## 14. Query Methodsë€ ë¬´ì—‡ì¼ê¹Œ?

- Query Methodsë€?
    - Spring Data JPAì—ì„œëŠ” ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ SQLì„ ìƒì„±í•  ìˆ˜ ìˆëŠ” Query Methods ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
    - JpaRepository ì¸í„°í˜ì´ìŠ¤ì—ì„œ í•´ë‹¹ ì¸í„°í˜ì´ìŠ¤ì™€ ë§¤í•‘ë˜ì–´ìˆëŠ” í…Œì´ë¸”ì— ìš”ì²­í•˜ê³ ìí•˜ëŠ” SQLì„ ë©”ì„œë“œ ì´ë¦„ì„ ì‚¬ìš©í•˜ì—¬ ì„ ì–¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        - [ì½”ë“œ ìŠ¤ë‹ˆí«] MemoRepository

            ```java
            package com.sparta.memo.repository;

            import com.sparta.memo.entity.Memo;
            import org.springframework.data.jpa.repository.JpaRepository;

            import java.util.List;

            public interface MemoRepository extends JpaRepository<Memo, Long> {
                List<Memo> findAllByOrderByModifiedAtDesc();
            }
            ```

    - **SimpleJpaRepository** í´ë˜ìŠ¤ê°€ ìƒì„±ë  ë•Œ ìœ„ì²˜ëŸ¼ ì§ì ‘ ì„ ì–¸í•œ JpaRepository ì¸í„°í˜ì´ìŠ¤ì˜ ëª¨ë“  ë©”ì„œë“œë¥¼ ìë™ìœ¼ë¡œ êµ¬í˜„í•´ì¤ë‹ˆë‹¤.
        - JpaRepository ì¸í„°í˜ì´ìŠ¤ì˜ ë©”ì„œë“œ ì¦‰, [Query Methods](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-creation)ëŠ” ê°œë°œìê°€ ì´ë¯¸ ì •ì˜ ë˜ì–´ìˆëŠ” ê·œì¹™ì— ë§ê²Œ ë©”ì„œë“œë¥¼ ì„ ì–¸í•˜ë©´ í•´ë‹¹ ë©”ì„œë“œ ì´ë¦„ì„ ë¶„ì„í•˜ì—¬ SimpleJpaRepositoryì—ì„œ êµ¬í˜„ì´ ë©ë‹ˆë‹¤.
        - ë”°ë¼ì„œ ìš°ë¦¬ëŠ” ì¸í„°í˜ì´ìŠ¤ì— í•„ìš”í•œ SQLì— í•´ë‹¹í•˜ëŠ” ë©”ì„œë“œ ì´ë¦„ íŒ¨í„´ìœ¼ë¡œ ë©”ì„œë“œë¥¼ ì„ ì–¸ í•˜ê¸°ë§Œ í•˜ë©´ ë”°ë¡œ êµ¬í˜„í•˜ì§€ ì•Šì•„ë„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - `findAllByOrderByModifiedAtDesc` í•´ë‹¹ ë©”ì„œë“œ ì´ë¦„ì€ Memo í…Œì´ë¸”ì—ì„œ ModifiedAt ì¦‰, ìˆ˜ì • ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ ì „ì²´ ë°ì´í„°ë¥¼ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ê°€ì ¸ì˜¤ëŠ” SQLì„ ì‹¤í–‰í•˜ëŠ” ë©”ì„œë“œë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - `List<Memo> findAllByUsername(String username);`
        - ì´ë ‡ê²Œ Query Methodë¥¼ ì„ ì–¸í–ˆì„ ê²½ìš° `ByUsername` ì— ê°’ì„ ì „ë‹¬í•´ì¤˜ì•¼í•˜ê¸° ë•Œë¬¸ì— íŒŒë¼ë¯¸í„°ì— í•´ë‹¹ ê°’ì˜ íƒ€ì…ê³¼ ë³€ìˆ˜ëª…ì„ ì„ ì–¸í•´ì¤ë‹ˆë‹¤.
        - ì¦‰, Query Methods ëŠ” ë©”ì„œë“œì˜ íŒŒë¼ë¯¸í„°ë¥¼ í†µí•´ SQLì— í•„ìš”í•œ ê°’ì„ ë™ì ìœ¼ë¡œ ë°›ì•„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- ë©”ëª¨ì¥ í”„ë¡œì íŠ¸ Query Methods ì ìš©
    - ìµœì‹  ë©”ëª¨ê°€ ê°€ì¥ ìƒë‹¨ì— ë‚˜ì˜¬ ìˆ˜ ìˆë„ë¡ ìˆ˜ì •

        ```java
        public List<MemoResponseDto> getMemos() {
            // DB ì¡°íšŒ
            return memoRepository.findAllByOrderByModifiedAtDesc().stream().map(MemoResponseDto::new).toList();
        }
        ```